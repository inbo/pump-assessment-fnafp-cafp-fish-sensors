---
title: "fish_main"
author: "Stijn Bruneel and Sarah Broos"
date: '19-02-2024'
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r}
# import libraries from file
source("./source/not_functions/libraries.R")
source("./source/not_functions/add_missing_folders.R")
```

|     |     | Category                                            |
|-----|-----|-----------------------------------------------------|
| 1\. |     | Alive, no injuries observed                         |
| 2\. |     | Alive, lightly injured                              |
|     | 2.1 | Red and/or injured eyes                             |
|     | 2.2 | Red and/or injured fins                             |
|     | 2.3 | Light scratches,contusions,scale loss \<20% of body |
| 3\. |     | Dying and/or heavily injured                        |
|     | 3.1 | Scale loss \>20% of body surface                    |
|     | 3.2 | Incisions, cuts, decapitation                       |
|     | 3.3 | Fracture(s)                                         |
|     | 3.4 | Heavily injured or missing eyes                     |
|     | 3.5 | Heavily injured gills or gill covers                |
|     | 3.6 | Heavy contusion or bleeding                         |
|     | 3.7 | Aberrant behavior                                   |
| 4\. |     | Dead fish                                           |

: Injury types according to NEN-guideline 8775

```{r}
# Use of abbreviations in names of data sets 
# OK = Oude Kale: Duivel
# f = forced tests
# bream = brasem
# roach = blankvoorn
# eel = paling

df_OK_f_bream <- read_excel("./data/fish/external/processed_in_excel/geforceerde_proeven_brasem_werkelijk toerental.xlsx")
df_OK_f_roach <- read_excel("./data/fish/external/processed_in_excel/geforceerde_proeven_bv_werkelijk toerental.xlsx")
df_OK_f_eel <- read_excel("./data/fish/external/processed_in_excel/geforceerde_proeven_paling_werkelijk toerental.xlsx")
df_OK_f_eel <- df_OK_f_eel[-which(df_OK_f_eel$Fin_cut=="onderlip doorgesneden"),]

df_OK_n_ad <- read_excel("./data/fish/external/processed_in_excel/natuurlijk.xlsx")
```

## Data processing

-   The injury classes were grouped in severity injury classes. The most severe severity injury class determined the severity injury class the individual was assigned to.
    
| Injury class | Severity injury class |
|--------------|-----------------------|
| 1\.          | No injury             |
| 2\.          | Slight injury         |
| 3\.          | Severe injury         |
| 4\.          | Dead                  |
: Grouping of injury classes into severity injury classes

-   Fish were classified as dead in case they were observed as dead or dying or alive with a severe injury.

-   Some fish were assigned to scenarios they were not initially intended for because they lingered along the trajectory of the pumps and were only recaptured after the assigned scenario ended and another scenario had already started. Because of this there can be a difference in the theoretical scenario fish were assigned to and the actual observed scenario. It was decided to reassign this fish to the scenario at which they were observed after passing the pump. 

-   The few missing length measurements were imputed based on the length-weight relationship per species.

-   Fish with outlying length values, i.e. values that fall outside of 3 times IQR below Q1 or 3 times IQR above Q3, were removed. Only for roach 5 fish were removed. 

```{r}
source("./source/not_functions/clean_data_forced.R")
source("./source/not_functions/clean_data_natural.R")
source("./source/functions/plot_histogram_length_weight_distribution.R")
source("./source/functions/stats_data_level1.R")
source("./source/functions/stats_data_level2a.R")
```

```{r include=FALSE}
# Run clean functions
df_OK_f_bream<-clean_data_OK(df_OK_f_bream,Control="Both",outlier.removal = TRUE) 
df_OK_f_roach<-clean_data_OK(df_OK_f_roach,Control="Both",outlier.removal = TRUE) 
df_OK_f_eel<-clean_data_OK(df_OK_f_eel,Control="Both",outlier.removal = TRUE); df_OK_f_eel<-df_OK_f_eel[df_OK_f_eel$SampleSize != c(' 10 dode palingen'),] 
df_OK_n_ad<-clean_data_OK_natural(df_OK_n_ad,Control="Both",outlier.removal = TRUE) 
```

```{r}
# Combine OK data of different species 
df_OK_f<-rbind(df_OK_f_bream,df_OK_f_roach,df_OK_f_eel)
```

```{r}
write.csv(df_OK_f_bream,"./data/fish/internal/additional/df_OK_f_bream.csv")
write.csv(df_OK_f_roach,"./data/fish/internal/additional/df_OK_f_roach.csv")
write.csv(df_OK_f_eel,"./data/fish/internal/additional/df_OK_f_eel.csv")
write.csv(df_OK_f,"./data/fish/internal/df_OK_f.csv")
write.csv(df_OK_n_ad,"./data/fish/internal/df_OK_n_ad.csv")
rm(df_OK_f_bream,df_OK_f_eel,df_OK_f_roach)
```

## Data overview: Exploratory analysis

```{r}
# Present the scenarios and fin cuts for OK
df_OK_f %>% distinct(Species, Pump_type, rpm, Fin_cut, Control) %>% arrange(Pump_type, Species, rpm, Control) %>% kable(caption="Different scenarios and samples for OK")
```

```{r}
# Number of recaptured individuals for OK
df_OK_f %>% group_by(Species) %>% distinct(Species, Individuals_ID) %>% count() %>% kable(caption="Number of recaptured individuals per species for OK")
```

```{r}
# Number of recaptured individuals per scenario and fin cut (n) and total number of recaptured individuals per species (Total) for OK
df_OK_f_temp <- df_OK_f %>% group_by(Species, Pump_type, rpm, Control, Fin_cut, number_of_released_fish) %>% distinct(Species, Pump_type, rpm, Control, Fin_cut, number_of_released_fish, Individuals_ID) %>% summarise(n = n()) %>% ungroup() %>% group_by(Species) %>% mutate(Total = sum(n)) %>% arrange(Species, Pump_type, rpm, Control) 
df_OK_f_temp %>% kable(caption = "Number of released fish per scenario and sample, Number of observed fish per scenario and sample (n) and total number of fish per species for OK.")
df_OK_f_temp_too_few_samples <- df_OK_f_temp[which(df_OK_f_temp$n<threshold_too_few_samples),]
if (Remove_too_few_samples=="NO"){write.csv(df_OK_f_temp_too_few_samples,"./data/fish/internal/df_OK_f_too_few_samples.csv")}
rm(df_OK_f_temp,df_OK_f_temp_too_few_samples)
```

```{r}
# Number of recaptured individuals per scenario (n) and total number of recaptured individuals per species (Total) for OK
df_OK_f %>% mutate(number_of_released_fish_per_scenario = replace(number_of_released_fish_per_scenario, Frequency_theoretical != Frequency, NA)) %>%
  group_by(Species, Pump_type, rpm, Control) %>%
  summarise(number_of_released_fish_per_scenario=mean(number_of_released_fish_per_scenario,na.rm=TRUE),n = n()) %>%
  ungroup() %>%
  group_by(Species) %>%
  mutate(recapture=n/number_of_released_fish_per_scenario,Total = sum(n)) %>%
  arrange(Species, Pump_type, rpm, Control) %>%
  kable(caption = "Number of released fish per scenario and sample, Number of observed fish per scenario and sample (n) and recapture rate for OK.")
```

## Data visualization

### Mortality

```{r}
# Run aggregation function to yield number of recaptured fish per scenario and fin cut for OK
df_OK_f_stat_level1 <- stats_data_level1(df_OK_f)
df_OK_f_stat_level1$Pump_type_Frequency <- paste(df_OK_f_stat_level1$Pump_type,df_OK_f_stat_level1$Frequency)
write.csv(df_OK_f_stat_level1,"./data/fish/internal/additional/df_OK_f_stat_level1.csv")
```

```{r fig.cap="Mortality in function of rpm per species for samples of OK. "}
# Boxplots of the percentage Alive versus Dead of recaptured fish per scenario and fin cut for OK
ggplot(data=df_OK_f_stat_level1[which(df_OK_f_stat_level1$Control=="pump" & df_OK_f_stat_level1$State=="Dead"),],aes(rpm, percentage_state_test),size = 0.5, color = "black") + geom_boxplot(linetype = 1, position = position_dodge(0.5)) + facet_grid(cols = vars(Species)) + ylab("Mortality (%)") + xlab("Operational pump \nmode (rpm)") + ylim(0,100) + theme_bw() + theme(text = element_text(size = 12, family = "serif"), axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5, family = "serif"), strip.background = element_rect(colour = "black", fill = "white"), legend.position = "bottom") + labs(color = "Operational pump \nmode (rpm)") + geom_point(data=df_OK_f_stat_level1[which(df_OK_f_stat_level1$Control=="control" & df_OK_f_stat_level1$State=="Dead"),],aes(rpm,percentage_state_test), alpha=1,position = position_dodge(0.5),shape=8)
```

```{r fig.cap="Mortality in function of rpm per species for samples of OK. "}
# Run aggregation function to yield number of recaptured fish per scenario for OK
df_OK_f_stat_level2a <- stats_data_level2a(df_OK_f_stat_level1[which(df_OK_f_stat_level1$number_recaptured>=10),],c("Species", "Pump_type", "rpm", "rpm", "Control", "State")) 
df_OK_f_stat_level2b <- stats_data_level2a(df_OK_f_stat_level1[which(df_OK_f_stat_level1$Frequency_theoretical==df_OK_f_stat_level1$Frequency),],c("Species", "Pump_type", "rpm", "rpm", "Control", "Fin_cut")) 
write.csv(df_OK_f_stat_level2a,"./data/fish/internal/additional/df_OK_f_stat_level2a.csv")
write.csv(df_OK_f_stat_level2b,"./data/fish/internal/additional/df_OK_f_stat_level2b.csv")

# Plots depicting average, minimum and maximum for the percentage Alive versus Dead of recaptured fish per scenario for OK
ggplot(data=df_OK_f_stat_level2a[which(df_OK_f_stat_level2a$Control=="pump" & df_OK_f_stat_level2a$State=="Dead"),],aes(rpm, percentage_state_test),size = 0.5, color = "black") + geom_pointrange(aes(ymin = min_state, ymax = max_state), linetype = 1, position = position_dodge(0.5)) + facet_grid(cols = vars(Species)) + ylab("Mortality (%)") + xlab("Operational pump \nmode (rpm)") + ylim(0,100) + theme_bw() + theme(text = element_text(size = 12, family = "serif"), axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5, family = "serif"), strip.background = element_rect(colour = "black", fill = "white"), legend.position = "bottom") + labs(color = "Operational pump \nmode (rpm)") + geom_point(data=df_OK_f_stat_level2a[which(df_OK_f_stat_level2a$Control=="control" & df_OK_f_stat_level2a$State=="Dead"),],aes(rpm, percentage_state_test),position = position_dodge(0.5),shape=8)
```

### Recapture percentage

```{r fig.cap="Recapture percentage in function of rpm (Hz) per species for samples of OK."}
# Recapture percentage OK (boxplots: per fin cut)
ggplot(data=df_OK_f_stat_level2b[which(df_OK_f_stat_level2b$Control=="pump"),],aes(rpm, 100*(number_recaptured/number_of_released_fish)),size = 0.5, color = "black") + geom_boxplot(linetype = 1, position = position_dodge(0.5)) + facet_grid(cols = vars(Species)) + ylab("Percentage \n of recovered fish (%)") + xlab("Operational pump \nmode (rpm)") + ylim(0,100) + theme_bw() + theme(text = element_text(size = 12, family = "serif"), axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5, family = "serif"), strip.background = element_rect(colour = "black", fill = "white"), legend.position = "bottom") + labs(color = "Pump_type") + geom_point(data=df_OK_f_stat_level2b[which(df_OK_f_stat_level2b$Control=="control"),],aes(rpm, 100*(number_recaptured/number_of_released_fish)),position = position_dodge(0.5),shape=8)
```

### Injuries

```{r}
# Turn wide data into long data based on the injuries for OK
df_OK_f %>% gather(.,key = Injury, Value, Class_1:Class_4, na.rm = FALSE) -> df_OK_f_long
df_OK_f %>% gather(.,key = Injury, Value, Injury_type_no:Injury_type_dead, na.rm = FALSE) -> df_OK_f_long_type

df_OK_n_ad %>% gather(.,key = Injury, Value, Class_1:Class_4, na.rm = FALSE) -> df_OK_n_ad_long
df_OK_n_ad %>% gather(.,key = Injury, Value, Injury_type_no:Injury_type_dead, na.rm = FALSE) -> df_OK_n_ad_long_type

df_OK_f_stat_level1 %>% gather(.,key = Injury, Value, Class_1:Class_4, na.rm = FALSE) -> df_OK_f_stat_level1_long
df_OK_f_stat_level1_long$percentage_injury_test <- df_OK_f_stat_level1_long$Value/df_OK_f_stat_level1_long$number_recaptured
df_OK_f_stat_level2a %>% gather(.,key = Injury, Value, Class_1:Class_4, na.rm = FALSE) -> df_OK_f_stat_level2a_long
df_OK_f_stat_level2a_long$percentage_injury_test <- df_OK_f_stat_level2a_long$Value/df_OK_f_stat_level2a_long$number_recaptured

write.csv(df_OK_f_long,"./data/fish/internal/additional/df_OK_f_long.csv")
write.csv(df_OK_f_long_type,"./data/fish/internal/additional/df_OK_f_long_type.csv")
write.csv(df_OK_n_ad_long,"./data/fish/internal/additional/df_OK_n_ad_long.csv")
write.csv(df_OK_n_ad_long_type,"./data/fish/internal/additional/df_OK_n_ad_long_type.csv")
write.csv(df_OK_f_stat_level1_long,"./data/fish/internal/additional/df_OK_f_stat_level1_long.csv")
write.csv(df_OK_f_stat_level2a_long,"./data/fish/internal/additional/df_OK_f_stat_level2a_long.csv")
```

```{r}
# How much fish (n) have more than one observed injury (Number_injuries) for OK
df_OK_f %>% filter(Frequency != "NA" & Number_Injuries != "NA") %>% group_by(Species, Pump_type, rpm, Control, Number_Injuries) %>% tally() %>% ungroup() %>% kable(caption = "number of fish with different numbers of injuries per scenario for OK.")
```

#### Injury plots OK

```{r fig.cap="Injury plots OK."}
# Injury plots for OK
ggplot(data=df_OK_f_stat_level1_long[which(df_OK_f_stat_level1_long$Control=="pump"),],aes(Injury, Value),size = 0.5, color = "black") + geom_boxplot(aes(color = rpm), linetype = 1, position = position_dodge(0.5)) + facet_grid(rows = vars(Species)) + ylab("Percentage \n of recovered fish (%)") + xlab("") + ylim(0,100) + theme_bw() + theme(text = element_text(size = 12, family = "serif"), axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5, family = "serif"), strip.background = element_rect(colour = "black", fill = "white"), legend.position = "bottom") + labs(color = "Operational pump \nmode (rpm)") + theme(axis.text.x = element_text(angle = 90)) + scale_x_discrete(label=function(x) abbreviate(x, minlength=1))

ggplot(data=df_OK_f_stat_level1_long[which(df_OK_f_stat_level1_long$Control=="pump"),],aes(Injury, Value),size = 0.5, color = "black") + geom_boxplot(aes(color = State), linetype = 1, position = position_dodge(0.5)) + facet_grid(rows = vars(Species)) + ylab("Percentage \n of recovered fish (%)") + xlab("") + ylim(0,100) + theme_bw() + theme(text = element_text(size = 12, family = "serif"), axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5, family = "serif"), strip.background = element_rect(colour = "black", fill = "white"), legend.position = "bottom") + labs(color = "State of fish") + theme(axis.text.x = element_text(angle = 90)) + scale_x_discrete(label=function(x) abbreviate(x, minlength=1))

ggplot(data=df_OK_f_stat_level2a_long[which(df_OK_f_stat_level2a_long$Control=="pump"),]) + geom_bar(aes(x=Injury, y=Value, fill=rpm), position = "dodge", stat = "identity") + facet_grid(rows = vars(Species)) + theme_bw() + xlab("Injury class") + ylab("Number of observations") + scale_fill_discrete(name = "Operational pump \nmode (rpm)") + theme(axis.text.x = element_text(angle = 90)) + scale_x_discrete(label=function(x) abbreviate(x, minlength=1))

ggplot(data=df_OK_f_stat_level2a_long[which(df_OK_f_stat_level2a_long$Control=="pump"),]) + geom_bar(aes(x=Injury, y=Value, fill=State), position = "dodge", stat = "identity") + facet_grid(rows = vars(Species)) + theme_bw() + xlab("Injury class") + ylab("Number of observations") + scale_fill_discrete(name = "State of the fish") + theme(axis.text.x = element_text(angle = 90)) + scale_x_discrete(label=function(x) abbreviate(x, minlength=1))

# Length versus weight plots for OK
specieslist_OK = unique(df_OK_f$Species)
injurylist_OK = unique(df_OK_f_stat_level1_long$Injury) 
injurylist_type_OK = unique(df_OK_f_long_type$Injury)
write.csv(specieslist_OK,"./data/fish/internal/specieslist_OK.csv")
write.csv(injurylist_OK,"./data/fish/internal/injurylist_OK.csv")
write.csv(injurylist_type_OK,"./data/fish/internal/injurylist_type_OK.csv")

for(i in specieslist_OK){
    
print(df_OK_f %>%
  filter(rpm != "NA" & Length != "NA" & Weight != "NA") %>%
  filter(Species == i) %>%
  dplyr::select(rpm, Fin_cut, Length, Weight, Individuals_ID) %>%
  distinct(rpm, Fin_cut, Length, Weight, Individuals_ID) %>%
  ggplot(aes(x=Length, y=Weight, shape=Fin_cut))+ geom_point(color='black') + facet_grid(cols = vars(rpm)) + theme_bw() + theme(legend.position = "none",strip.background = element_rect(colour = "black", fill = "white")) + scale_shape_manual(values = c(1,2,3,4,5,6,7,8,9,10,11,12)) + scale_color_manual(values="black") + ggtitle(i))
}
```

```{r}
plot_injury_length<-list()
k=0
for(i in specieslist_OK){
  k=k+1  
  plot_injury_length[[k]]<-(df_OK_f_long_type %>%
    filter(Frequency != "NA" & Length != "NA" & Value == 1 & Control=="pump") %>%
    filter(Species == i) %>%
    dplyr::select(Injury, Pump_type_rpm, Frequency, Fin_cut, Length, Individuals_ID) %>%
    distinct(Injury, Pump_type_rpm, Frequency, Fin_cut, Length, Individuals_ID) %>%
    ggplot(aes(x=Injury, y=Length))+ geom_boxplot(color='black') + theme_bw() + theme(legend.position = "none",strip.background = element_rect(colour = "black", fill = "white")) + facet_grid(cols = vars(Pump_type_rpm)) + scale_color_manual(values="black") + ggtitle(i) + theme(axis.text.x = element_text(angle = 60, hjust = 1))) 
  print(plot_injury_length[[k]])
  }
```

```{r}
plot_mort_length<-list()
k=0
for(i in specieslist_OK){
  k=k+1 
  plot_mort_length[[k]]<-(df_OK_f %>%
    filter(Frequency != "NA" & Length != "NA" & Control=="pump") %>%
    filter(Species == i) %>%
    dplyr::select(State, Pump_type_rpm, Frequency, Fin_cut, Length, Individuals_ID) %>%
    distinct(State, Pump_type_rpm, Frequency, Fin_cut, Length, Individuals_ID) %>%
    ggplot(aes(x=State, y=Length))+ geom_boxplot(color='black') + theme_bw() + theme(legend.position = "none",strip.background = element_rect(colour = "black", fill = "white")) + facet_grid(cols = vars(Pump_type_rpm)) + scale_color_manual(values="black") + ggtitle(i) + theme(axis.text.x = element_text(angle = 60, hjust = 1))) 
  print(plot_mort_length[[k]])
  }
```

### Length distributions

#### Histograms length distributions OK

```{r}
#Length distribution for OK
plot.histogram.length.weight.distribution(df_OK_f,"Length",type="hist") %>% kable(caption="summary statistics length OK")
plot.histogram.length.weight.distribution(df_OK_f,"Weight",type="hist") %>% kable(caption="summary statistics weight OK")
```

#### Density plots length distributions OK

```{r}
#Length distribution for OK
plot.histogram.length.weight.distribution(df_OK_f,"Length",type="dens",summarystats=FALSE)
plot.histogram.length.weight.distribution(df_OK_f,"Weight",type="dens",summarystats=FALSE)
```

```{r}
df_OK_f$nState=NA
df_OK_f$nState[which(df_OK_f$State=="Alive")]=1
df_OK_f$nState[which(df_OK_f$State=="Dead")]=0
```

```{r}
# Chi-squared test data for state OK
df_OK_f_stat_level2a_wide <- as.data.frame(df_OK_f_stat_level2a %>% 
  dplyr::select(c("Species","Pump_type","rpm","Control","number_state_binom","State")) %>% #Using percentage makes more sense than n_state_binom because different fin_cuts have different sample sizes (this difference is accounted for in the percentage) 
  spread(State,number_state_binom)) 
write.csv(df_OK_f_stat_level2a_wide,"./data/fish/internal/NP/df_OK_f_stat_level2a_wide.csv")

df_OK_f_stat_level2a_wide_species_pump <- as.data.frame(stats_data_level2a(df_OK_f_stat_level2a,c("Species", "Pump_type", "Control", "State")) %>% 
  dplyr::select(c("Species","Pump_type","Control","number_state_binom","State")) %>% #Using percentage makes more sense than n_state_binom because different fin_cuts have different sample sizes (this difference is accounted for in the percentage) 
  spread(State,number_state_binom)) 
write.csv(df_OK_f_stat_level2a_wide_species_pump,"./data/fish/internal/NP/df_OK_f_stat_level2a_wide_species_pump.csv")

df_OK_f_stat_level2a_wide_freq_pump <- as.data.frame(stats_data_level2a(df_OK_f_stat_level2a,c("rpm", "Pump_type","Control" ,"State")) %>% 
  dplyr::select(c("Pump_type","rpm","Control","number_state_binom","State")) %>% #Using percentage makes more sense than n_state_binom because different fin_cuts have different sample sizes (this difference is accounted for in the percentage) 
  spread(State,number_state_binom)) 
write.csv(df_OK_f_stat_level2a_wide_freq_pump,"./data/fish/internal/NP/df_OK_f_stat_level2a_wide_freq_pump.csv")

```

```{r}
# Chi-squared test data for injury OK
df_OK_f_stat_level3 <- stats_data_level2a(df_OK_f_stat_level1,c("Species", "Pump_type", "rpm","Control"))
df_OK_f_stat_level3 <- as.data.frame(df_OK_f_stat_level3 %>% 
  #mutate_at(vars(contains('Class')), ~./number_state_binom) %>% 
  #mutate_at(vars(contains('Class')), .funs = list(perc = ~./number_state_binom)) %>%
  #mutate_at(vars(contains("Class")), ~sum(.)) %>%
  dplyr::select(-number_recaptured, -percentage_state_test, -min_state, -max_state, -Weight, -Length, -Number_Injuries, -number_of_released_fish,-number_of_released_fish_per_scenario,-number_state_binom, -Injury_type_no, -Injury_type_slight, -Injury_type_severe, -Injury_type_dead))
df_OK_f_stat_level3$Class_3.3<-NULL
df_OK_f_stat_level3$Class_3.7<-NULL
write.csv(df_OK_f_stat_level3,"./data/fish/internal/NP/df_OK_f_stat_level3.csv")
```

```{r}
# Chi-squared test data for injury OK
df_OK_f_stat_level3b <- stats_data_level2a(df_OK_f_stat_level1,c("Species", "Pump_type", "rpm","Control"))
df_OK_f_stat_level3b <- as.data.frame(df_OK_f_stat_level3b %>% 
  dplyr::select(Species, Pump_type, rpm, Control, Injury_type_no, Injury_type_slight, Injury_type_severe, Injury_type_dead))
write.csv(df_OK_f_stat_level3b,"./data/fish/internal/NP/df_OK_f_stat_level3b.csv")
```

