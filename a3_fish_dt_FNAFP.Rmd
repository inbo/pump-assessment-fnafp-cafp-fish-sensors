---
title: "fish_dt_FNAFP"
author: "Stijn Bruneel"
date: '2022-10-05'
output: word_document
---

```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
# import libraries from file
source("./source/not_functions/libraries.R")
```

```{r}
source("./source/functions/log_model_state.R")
source("./source/functions/plot_histogram_length_weight_distribution.R")
source("./source/functions/run_chi_squared.R")
source("./source/functions/stats_data_level1.R")
source("./source/functions/stats_data_level2a.R")
source("./source/functions/rmse.R")
```

```{r}
df_OK_f <- read.csv("./data/fish/internal/df_OK_f.csv")
df_OK_f$rpm<-as.factor(df_OK_f$rpm)
Language="english"

df_OK_f$nState=NA
df_OK_f$nState[which(df_OK_f$State=="Alive")]=1
df_OK_f$nState[which(df_OK_f$State=="Dead")]=0

df_OK_f$State=as.factor(df_OK_f$State)
df_OK_f$State <- relevel(df_OK_f$State, ref = "Dead")
```

```{r}
df_OK_f_long_type <- read.csv("./data/fish/internal/df_OK_f_long_type.csv")
df_OK_f_long_type<-df_OK_f_long_type[-which(df_OK_f_long_type$Value==0 | df_OK_f_long_type$Injury=="Injury_type_dead"),]
df_OK_f_long_type$rpm=as.factor(df_OK_f_long_type$rpm)
df_OK_f_long <- read.csv("./data/fish/internal/df_OK_f_long.csv")
df_OK_f_long<-df_OK_f_long[-which(df_OK_f_long$Value==0 | df_OK_f_long$Injury=="Class_4"),]
df_OK_f_long$rpm=as.factor(df_OK_f_long$rpm)

if (exists("Language")){
  if (Language=="dutch"){
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_no")] = "geen"
    df_OK_f_long_type["Injury"][df_OK_f_long_type["Injury"] == "Injury_type_no"] <- "geen"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_slight")] <- "licht"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_severe")] <- "zwaar"
  }
  if (Language=="english"){
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_no")] = "no"
    df_OK_f_long_type["Injury"][df_OK_f_long_type["Injury"] == "Injury_type_no"] <- "no"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_slight")] <- "slight"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_severe")] <- "severe"
    df_OK_f_long_type$Injury <- factor(df_OK_f_long_type$Injury, levels=c("no", "slight", "severe"))
  }
}
```

```{r}
specieslist_OK <- read.csv("./data/fish/internal/specieslist_OK.csv")[,2]
injurylist_OK <- read.csv("./data/fish/internal/injurylist_OK.csv")[,2]
injurylist_type_OK <- read.csv("./data/fish/internal/injurylist_type_OK.csv")[,2]
```

```{r}
df_OK_f$Control_or_pump=df_OK_f$Control
df_OK_f_long_type$Control_or_pump=df_OK_f_long_type$Control
df_OK_f_long$Control_or_pump=df_OK_f_long$Control
```

## Methodology

In addition to the logistic models, to assess the survival probability, and multinomial models, to assess the injury probability, decision trees were constructed. To assess the survival rate for the different scenarios of the FNAFP, decision trees were developed for the entire dataset and for each species separately. These provide an intuitive and clear overview of the data and underlying patterns. The state of each fish (alive=1 versus dead=0) was used as response. The explanatory variables were species (discrete), rpm (discrete) and fish length (continuous).

## Results

```{r}
control <- rpart.control(minsplit = 45)
color.selection <- "-GnYlRd"

pdf("./figures/manuscript/dt_mort.pdf")

par(mfrow = c(1,2))

# CRT for state OK 
form.state.df.tree <- as.formula(State ~ rpm + Control_or_pump + Species)
model.state.df.tree <- rpart(form.state.df.tree,df_OK_f,control=control)
a<-fancyRpartPlot(model.state.df.tree,main="All species",box.palette=color.selection,palettes = "PuRd")
a
model.state.df.tree$variable.importance/max(model.state.df.tree$variable.importance)
rmse(predict(model.state.df.tree,df_OK_f),df_OK_f)
model.state.df.tree.pred = predict(model.state.df.tree, data = df_OK_f, type="class")
table(df_OK_f$State, model.state.df.tree.pred)

# form.state.df.tree <- as.formula(State ~ rpm + Species + Length)
# model.state.df.tree <- rpart(form.state.df.tree,df_OK_f[which(df_OK_f$Control=="pump"),],control=control)
# rpart.plot(model.state.df.tree,main="without control",box.palette=color.selection)
# model.state.df.tree$variable.importance/max(model.state.df.tree$variable.importance)
# rmse(predict(model.state.df.tree,df_OK_f[which(df_OK_f$Control=="pump"),]),df_OK_f[which(df_OK_f$Control=="pump"),])

k=0
model.state.df.tree<-list()
b<-list()
for(i in specieslist_OK[1]){
  k=k+1
  form.state.df.tree <- as.formula(State ~ rpm + Length + Control_or_pump)
  model.state.df.tree[[k]] <- rpart(form.state.df.tree,df_OK_f[which(df_OK_f$Species==i),],control=control)
  b[[k]]<-fancyRpartPlot(model.state.df.tree[[k]],main=paste(toupper(substr(i, 1, 1)), substr(i, 2, nchar(i)), sep="")
,box.palette=color.selection,palettes = "PuRd")
  b[[k]]
  print(model.state.df.tree[[k]]$variable.importance/max(model.state.df.tree[[k]]$variable.importance))
  print(rmse(predict(model.state.df.tree[[k]],df_OK_f[which(df_OK_f$Species==i),]),df_OK_f[which(df_OK_f$Species==i),]))
}

# k=0
# model.state.df.tree<-list()
# for(i in specieslist_OK[1:2]){
#   k=k+1
#   form.state.df.tree <- as.formula(State ~ rpm + Length)
#   model.state.df.tree[[k]] <- rpart(form.state.df.tree,df_OK_f[which(df_OK_f$Species==i & df_OK_f$Control=="pump"),],control=control)
#   rpart.plot(model.state.df.tree[[k]],main=paste(i,"without control"),box.palette=color.selection)
#   print(model.state.df.tree[[k]]$variable.importance/max(model.state.df.tree[[k]]$variable.importance))
#   print(rmse(predict(model.state.df.tree[[k]],df_OK_f[which(df_OK_f$Species==i),]),df_OK_f[which(df_OK_f$Species==i),]))
# }
dev.off()

print(specieslist_OK)
```

When considering the FNAFP decision tree for all three species it became clear that the species and type of sample (i.e. control versus pump-passage) were most important to estimate the survival rate. Eel (either belonging to the control or pump-passage samples) had a survival rate of 100%. The remaining control samples, consisting entirely of roach and bream, had a survival rate of 99% (which can be traced back to one roach with a severe injury). The last node of the decision tree distinguished between bream (23% survival rate) and roach (70% survival rate). Since all roach were smaller than all bream, this criterium could also have been perfectly replaced by a node that distinguishes between fish larger or smaller than 200 mm. It is therefore difficult to disentangle whether the higher survival probability of roach compared to bream is because of (i) the lower length of the former (population average of 168 mm for roach versus a population average of 374 mm for bream), (ii) the species-specific behaviour and/or vulnerability, or (iii) a combination of both. When considering the species separately, no decision tree could be developed for roach or eel, because the factors (pump passage versus control, rpm and fish length) had no strong effect on their observed survival rate. For bream an obvious first distinction was made based on whether a fish passed the pump (23% survival rate for the pump passage samples) or not (100% survival rate for the control samples). Bream that were smaller than 340 mm had a 67 and 27% survival chance if they went through the pump when the rpm was low versus high respectively. Bream larger than 340 mm had a survival rate of 18%, regardless of the rpm regime. 

```{r}
# CRT for injury (aggregated) OK
control <- rpart.control(minsplit = 45)
color.selection <- "GnYlRd"

pdf("./figures/manuscript/dt_injury.pdf")

par(mfrow = c(1,2))

#df_OK_f_long_type <-df_OK_f_long_type[order(df_OK_f_long_type$Injury),]

form.state.df.tree <- as.formula(Injury ~ Species + rpm + Control_or_pump + Length)
model.injury.df.tree <- rpart(form.state.df.tree, data = df_OK_f_long_type,control=control)
c<-fancyRpartPlot(model.injury.df.tree,main="full data",box.palette = color.selection, legend.x = NA, palettes = "PuRd",xflip=TRUE)
c
model.injury.df.tree$variable.importance/max(model.injury.df.tree$variable.importance)

model.injury.df.tree<-list()
k=0
d<-list()
for(i in "bream"){
  k=k+1
  form.state.df.tree <- as.formula(Injury ~ rpm + Control_or_pump + Length)
  model.injury.df.tree[[k]] <- rpart(form.state.df.tree, data = df_OK_f_long_type[which(df_OK_f_long_type$Species==i),],control=control)
  d[[k]]<-fancyRpartPlot(model.injury.df.tree[[k]],main=paste(i),box.palette = color.selection, legend.x = NA, palettes = "PuRd",xflip=TRUE)
  d[[k]]
  model.injury.df.tree[[k]]$variable.importance/max(model.injury.df.tree[[k]]$variable.importance)
}
dev.off()
```

When considering the severity of the injuries, eel, either from a control sample or pump sample, had the highest change of no injury (93%) and the lowest change of a slight (7%) or severe injury (0%). Roach or Bream that belonged to a control sample had a slightly lower, but still high, chance of no injury (86%). They had a slightly higher chance of a slight (12%) and severe injury (1%). From the remaining fish, fish that were smaller than 198 mm (all remaining roach) had a chance of no injury, slight injury and severe injury of 50%, 34% and 16% respectively. Fish that were larger than 198 mm (all remaining bream) had a chance of no injury, slight injury and severe injury of 4%, 27% and 68% respectively.

When considering the species separately, no decision tree could be developed for neither roach nor eel. Bream that were part of control samples were most likely to have no injuries. Bream with a length smaller than 340 mm, were most likely to get a slight injury when rpm was low and a severe injury when rpm was high. Bream with a length of more than 340 mm were most likely to get a severe injury. 


```{r}
# CRT for injury OK
control <- rpart.control(minsplit = 100)
color.selection <- "GnYlRd"
par(mfrow = c(1,1))

pdf("./figures/manuscript/dt_injury_type_all.pdf")
form.state.df.tree <- as.formula(Injury ~ Species + rpm + Control_or_pump + Length)
model.injury.df.tree <- rpart(form.state.df.tree, data = df_OK_f_long,control=control)
e<-fancyRpartPlot(model.injury.df.tree,main="full data",box.palette = color.selection, legend.x = NA, palettes = "PuRd", xflip=TRUE)
e
model.injury.df.tree$variable.importance/max(model.injury.df.tree$variable.importance)
dev.off()

model.injury.df.tree<-list()
k=0
f<-list()
for(i in specieslist_OK[c(1:2)]){
  k=k+1
  pdf(paste0("./figures/manuscript/dt_injury_type_",i,".pdf"))
  form.state.df.tree <- as.formula(Injury ~ rpm + Control_or_pump + Length)
  model.injury.df.tree[[k]] <- rpart(form.state.df.tree, data = df_OK_f_long[which(df_OK_f_long$Species==i),],control=control)
  f[[k]]<-fancyRpartPlot(model.injury.df.tree[[k]],main=paste(i),box.palette = color.selection, legend.x = NA, palettes = "PuRd", xflip=TRUE)
  f[[k]]
  model.injury.df.tree[[k]]$variable.importance/max(model.injury.df.tree[[k]]$variable.importance)
  dev.off()
}
```

When considering the type of the injuries, eel samples, control samples and samples with a length of less than 196 mm (all roach) were most likely to have no injury. Fish larger than 196 mm (all remaining bream) were most likely to have a 3.2 injury (Incisions, cuts, decapitation). If however, the length of the fish was between 196 and 340 the most likely injury would be 2.3 (Light scratches,contusions,scale loss \<20% of body).

```{r}
# Random forest state OK
form.state.df.forest <- as.formula(nState ~ rpm + Species + Length + Control)
model.state.df.forest <- ranger(form.state.df.forest,df_OK_f[which(is.na(df_OK_f$Length)==FALSE),],num.trees=500,respect.unordered.factors = "order",importance="permutation")
model.state.df.forest$variable.importance
rmse(predict(model.state.df.forest,df_OK_f[which(is.na(df_OK_f$Length)==FALSE),])$predictions,df_OK_f[which(is.na(df_OK_f$Length)==FALSE),])

form.state.df.forest <- as.formula(nState ~ rpm + Species + Length)
model.state.df.forest <- ranger(form.state.df.forest,df_OK_f[which(is.na(df_OK_f$Length & df_OK_f$Control=="pump")==FALSE),],num.trees=100,respect.unordered.factors = "order",importance="permutation")
model.state.df.forest$variable.importance
rmse(predict(model.state.df.forest,df_OK_f[which(is.na(df_OK_f$Length & df_OK_f$Control=="pump")==FALSE),])$predictions,df_OK_f[which(is.na(df_OK_f$Length & df_OK_f$Control=="pump")==FALSE),])

k=0
model.state.df.forest<-list()
for(i in specieslist_OK){
  print(i)
  k=k+1
  form.state.df.forest <- as.formula(nState ~ rpm + Length + Control)
  model.state.df.forest[[k]] <- ranger(form.state.df.forest,df_OK_f[which(df_OK_f$Species==i & is.na(df_OK_f$Length)==FALSE),],num.trees=100,respect.unordered.factors = "order",importance="permutation")
  print(model.state.df.forest[[k]]$variable.importance)
  print(rmse(predict(model.state.df.forest[[k]],df_OK_f[which(df_OK_f$Species==i & is.na(df_OK_f$Length)==FALSE),])$predictions,df_OK_f[which(df_OK_f$Species==i & is.na(df_OK_f$Length)==FALSE),]))

}

k=0
model.state.df.forest<-list()
for(i in specieslist_OK){
  print(i)
  k=k+1
  form.state.df.forest <- as.formula(nState ~ rpm + Length)
  model.state.df.forest[[k]] <- ranger(form.state.df.forest,df_OK_f[which(df_OK_f$Species==i & is.na(df_OK_f$Length)==FALSE & df_OK_f$Control=="pump"),],num.trees=100,respect.unordered.factors = "order",importance="permutation")
  print(model.state.df.forest[[k]]$variable.importance)
  print(rmse(predict(model.state.df.forest[[k]],df_OK_f[which(df_OK_f$Species==i & is.na(df_OK_f$Length)==FALSE & df_OK_f$Control=="pump"),])$predictions,df_OK_f[which(df_OK_f$Species==i & is.na(df_OK_f$Length)==FALSE & df_OK_f$Control=="pump"),]))

}
```

