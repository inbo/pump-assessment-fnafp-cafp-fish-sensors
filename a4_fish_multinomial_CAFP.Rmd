---
title: "fish_multinomial_CAFP"
author: "Stijn Bruneel"
date: '2022-10-08'
output: word_document
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r include=FALSE}
# import libraries from file
source("./source/not_functions/libraries.R")
```

```{r include=FALSE}
source("./source/functions/log_model_state.R")
source("./source/functions/plot_histogram_length_weight_distribution.R")
source("./source/functions/run_chi_squared.R")
source("./source/functions/stats_data_level1.R")
source("./source/functions/stats_data_level2a.R")
source("./source/functions/rmse.R")
source("./source/functions/export_emmeans.R")
source("./source/functions/round_df.R")
```

```{r include=FALSE}
Language<-"english"
df_OK_f <- read.csv("./data/fish/internal/df_OK_f.csv")
df_OK_n_ad <- read.csv("./data/fish/internal/df_OK_n_ad.csv")
df_OK_f <- bind_rows(df_OK_f,df_OK_n_ad)
df_OK_f <- df_OK_f[which(df_OK_f$Species=="roach"),]

df_OK_f$Frequency<-as.factor(df_OK_f$Frequency)
df_OK_f$frpm <- as.factor(df_OK_f$rpm)
```

```{r include=FALSE}
df_OK_f_long_type <- read.csv("./data/fish/internal/df_OK_f_long_type.csv")
df_OK_n_ad_long_type <- read.csv("./data/fish/internal/df_OK_n_ad_long_type.csv")
df_OK_f_long_type <- bind_rows(df_OK_f_long_type,df_OK_n_ad_long_type)
df_OK_f_long_type<- df_OK_f_long_type[which(df_OK_f_long_type$Species=="roach"),]

df_OK_f_long_type<-df_OK_f_long_type[-which(df_OK_f_long_type$Value==0 | df_OK_f_long_type$Injury=="Injury_type_dead"),]
if (exists("Language")){
  if (Language=="dutch"){
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_no")] = "geen"
    df_OK_f_long_type["Injury"][df_OK_f_long_type["Injury"] == "Injury_type_no"] <- "geen"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_slight")] <- "licht"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_severe")] <- "zwaar"
  }
  if (Language=="english"){
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_no")] = "no"
    df_OK_f_long_type["Injury"][df_OK_f_long_type["Injury"] == "Injury_type_no"] <- "no"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_slight")] <- "slight"
    df_OK_f_long_type$Injury[which(df_OK_f_long_type$Injury=="Injury_type_severe")] <- "severe"
    df_OK_f_long_type$Injury <- factor(df_OK_f_long_type$Injury, levels=c("no", "slight", "severe"))
  }
}
df_OK_f_long_type$Injury<-as.factor(df_OK_f_long_type$Injury)
df_OK_f_long_type$Control<-as.factor(df_OK_f_long_type$Control)
df_OK_f_long_type$Frequency<-as.factor(df_OK_f_long_type$Frequency)
df_OK_f_long_type$frpm <- as.factor(df_OK_f_long_type$rpm)
df_OK_f_long <- read.csv("./data/fish/internal/df_OK_f_long.csv")
df_OK_n_ad_long <- read.csv("./data/fish/internal/df_OK_n_ad_long.csv")
df_OK_f_long <- bind_rows(df_OK_f_long,df_OK_n_ad_long)
df_OK_f_long<-df_OK_f_long[-which(df_OK_f_long$Value==0 | df_OK_f_long$Injury=="Class_4"),]
df_OK_f_long$Injury<-as.factor(df_OK_f_long$Injury)
df_OK_f_long$Control<-as.factor(df_OK_f_long$Control)
df_OK_f_long$Frequency<-as.factor(df_OK_f_long$Frequency)
df_OK_f_long$frpm <- as.factor(df_OK_f_long$rpm)
```

```{r include=FALSE}
specieslist_OK <- "roach"
injurylist_OK <- read.csv("./data/fish/internal/injurylist_OK.csv")[,2]
injurylist_type_OK <- read.csv("./data/fish/internal/injurylist_type_OK.csv")[,2]
```

## Methodology

Methods: To identify the factors affecting injuries, multinomial models with as response the original injury class (1, 2.1, 2.2, etc.) or the severity injury class (no, slight and severe) were constructed. To obtain the most parsimonious model, step-wise model selection with AIC as selection criterion, was performed.

## Results

### Roach + severity injury class

```{r include=FALSE}
# multinom for injury (aggregated) OK
form.state.df.multinom <- as.formula(Injury ~ Pump_type_rpm * Length)
#df_OK_f_long_type$Injury <- relevel(df_OK_f_long_type$Injury, ref = "Injury_type_no")
model.injury.df.multinom=stepAIC(multinom(formula = form.state.df.multinom, data = df_OK_f_long_type[which(df_OK_f_long_type$Control=="pump"),]))
```

```{r echo=FALSE}
summary(model.injury.df.multinom)$coefficients %>% kable(caption="Coefficients of the model for both species + severity injury class")
z <- summary(model.injury.df.multinom)$coefficients/summary(model.injury.df.multinom)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2 
p %>% kable(caption="p-values of the model for both species + severity injury class")
exp(coef(model.injury.df.multinom)) %>% kable(caption="Relative risk ratio (RR) for a one-unit increase in the considered variable to be identified as the considered class vs no injury. RR<1: Decrease of the probability of the considered factor versus the reference class (No injury). RR>1: Increase of the probability of the considered factor versus the reference class (No injury)")
```

```{r eval =FALSE, fig.cap="Probability of type of injury occuring in function of length and screw type"}
temp <- df_OK_f_long_type %>% tidyr::expand(Species,Pump_type_rpm,full_seq(Length,1))
colnames(temp)[3] <- "Length"
temp.pp<-cbind(temp,predict(model.injury.df.multinom, newdata = temp, "probs"))
temp.pp$Species_Pump_type_rpm <- paste(temp.pp$Species,temp.pp$Pump_type_rpm)
lpp <- melt(temp.pp, id.vars = c("Species_Pump_type_rpm", "Length"), value.name = "probability")
ggplot(lpp, aes(x = Length, y = probability, colour = Species_Pump_type_rpm)) + geom_point() + facet_grid(variable ~., scales = "free")
```

### Roach + severity injury class (without considering length)

```{r}
# multinom for injury (aggregated) OK
model.injury.df.multinom<-list()
k=0
sum.mult=list()
z=list()
p=list()
l=list()
for(i in specieslist_OK){
  print(i)
  k=k+1
  form.state.df.multinom <- as.formula(Injury ~ Pump_type_rpm)
  model.injury.df.multinom[[k]] <- (multinom(formula = form.state.df.multinom, data = df_OK_f_long_type[which(df_OK_f_long_type$Control=="pump" & df_OK_f_long_type$Species==i),]))
  sum.mult[[k]]<-summary(model.injury.df.multinom[[k]])
  z[[k]] <- sum.mult[[k]]$coefficients/sum.mult[[k]]$standard.errors
  p[[k]] <- (1 - pnorm(abs(z[[k]]), 0, 1)) * 2
  emm_multinom1<-emmeans(model.injury.df.multinom[[k]], pairwise~Injury|Pump_type_rpm, type="response")
  print(emm_multinom1)
  print(plot(emm_multinom1,PIs=FALSE,CI=TRUE,comparisons=FALSE,adjust="bonferroni",colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw(base_size=18)+xlab("Probability")+ylab("Injury"))
  export.emmeans(emm_multinom1,"Oude_Kale","emm_multinom_without_length_per_scenario_natural",i)
  emm_multinom2<-emmeans(model.injury.df.multinom[[k]], pairwise~Pump_type_rpm|Injury, type="response")
  print(emm_multinom2)
  pdf(paste0("./figures/additional/mult_model_",i,"_natural.pdf"))
  print(plot(emm_multinom2,PIs=FALSE,CI=TRUE,comparisons=FALSE,adjust="bonferroni",colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw(base_size=18)+xlab("Probability")+ylab("Scenario")+xlim(-0.05,1.05))
  dev.off()
  export.emmeans(emm_multinom2,"Oude_Kale","emm_multinom_without_length_per_injury_type_natural",i)
  l[[k]]<-plot(emm_multinom2,PIs=FALSE,CI=TRUE,comparisons=FALSE,adjust="bonferroni",colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw(base_size=18)+xlab("Probability")+ylab("Scenario")+xlim(-0.05,1.05)
}
pdf("./figures/additional/mult_model_roach_natural.pdf",width=7,height=7)
ggarrange(l[[1]],labels=c("Roach"))
dev.off()
```

### Roach + severity injury class (with considering length if retained)

```{r}
# multinom for injury (aggregated) OK
model.injury.df.multinom<-list()
emm_multinom1_with_length<-list()
emm_multinom2_with_length<-list()
emm_multinom1_plot_with_length<-list()
emm_multinom2_plot_with_length<-list()
k=0
sum.mult=list()
z_with_length=list()
p_with_length=list()
for(i in specieslist_OK){
  print(i)
  k=k+1
  form.state.df.multinom <- as.formula(Injury ~ Pump_type_rpm * Length)
  if (length(unique(df_OK_f_long_type$Injury[which(df_OK_f_long_type$Control=="pump" & df_OK_f_long_type$Species==i)]))>2){
    model.injury.df.multinom[[k]] <- stepAIC(multinom(formula = form.state.df.multinom, data = df_OK_f_long_type[which(df_OK_f_long_type$Control=="pump" & df_OK_f_long_type$Species==i),]))
    sum.mult[[k]]<-summary(model.injury.df.multinom[[k]])
    z_with_length[[k]] <- sum.mult[[k]]$coefficients/sum.mult[[k]]$standard.errors
    p_with_length[[k]] <- (1 - pnorm(abs(z_with_length[[k]]), 0, 1)) * 2
    emm_multinom1_with_length[[k]]<-emmeans(model.injury.df.multinom[[k]], pairwise~Injury|Pump_type_rpm, type="response")
    print(emm_multinom1_with_length[[k]])
    emm_multinom1_plot_with_length[[k]]<-plot(emm_multinom1_with_length[[k]],PIs=FALSE,CI=TRUE,comparisons=FALSE,colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw()+xlab("Probability")+ylab("Injury")
    print(emm_multinom1_plot_with_length[[k]])
    pdf(paste("./figures/additional/emm_multinom1_plot_",i,"_natural.pdf",sep=""))
    print(emm_multinom1_plot_with_length[[k]])
    dev.off()
    export.emmeans(emm_multinom1_with_length[[k]],"Oude_Kale","emm_multinom_with_length_per_scenario_natural",i)
    emm_multinom2_with_length[[k]]<-emmeans(model.injury.df.multinom[[k]], pairwise~Pump_type_rpm|Injury, type="response")
    print(emm_multinom2_with_length[[k]])
    emm_multinom2_plot_with_length[[k]]<-plot(emm_multinom2_with_length[[k]],PIs=FALSE,CI=TRUE,comparisons=FALSE,colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw()+xlab("Probability")+ylab("Scenario")
    print(emm_multinom2_plot_with_length[[k]])
    pdf(paste("./figures/additional/emm_multinom2_plot_",i,"_natural.pdf",sep=""))
    print(emm_multinom2_plot_with_length[[k]])
    dev.off()
    export.emmeans(emm_multinom2_with_length[[k]],"Oude_Kale","emm_multinom_with_length_per_injury_type_natural",i)
  }
  if (length(unique(df_OK_f_long_type$Injury[which(df_OK_f_long_type$Control=="pump" & df_OK_f_long_type$Species==i)]))==2){
    model.injury.df.multinom[[k]] <- log.model.state(form = form.state.df.multinom, data = df_OK_f_long_type[which(df_OK_f_long_type$Control=="pump" & df_OK_f_long_type$Species==i),],type="simple")
emm_multinom1_with_length[[k]]<-emmeans(model.injury.df.multinom[[k]], pairwise~Pump_type_rpm, type="response")
    print(emm_multinom1_with_length[[k]])
    emm_multinom1_plot_with_length[[k]]<-plot(emm_multinom1_with_length[[k]],PIs=FALSE,CI=TRUE,comparisons=FALSE,colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw()+xlab("Probability")+ylab("Slight injury")
    print(emm_multinom1_plot_with_length[[k]])
    pdf(paste("./figures/additional/emm_multinom1_plot_",i,"_natural.pdf",sep=""))
    print(emm_multinom1_plot_with_length[[k]])
    dev.off()
    export.emmeans(emm_multinom1_with_length[[k]],"Oude_Kale","emm_multinom_with_length_per_scenario_natural",i)
  }
}
pdf("./figures/manuscript/mult_model_bream_roach_eel_length_natural.pdf",width=6,height=6)
ggarrange(emm_multinom2_plot_with_length[[1]],nrow=1,ncol=1,labels=c("Roach"))
dev.off()
```

For bream there was no significant difference in the number of fish without an injury between different rotation regimes. Eventhough the number of injuries might not have been significantly different between the two rotation regimes. Severe injuries were with marginal signficance more likely at higher rotations, while sligth injuries were with marginal signifcance more likley at lower rotations. The same pattern was found for roach with the exception that the higher risk of severe injuries at higher rotations was not significant. For eel there were no severe injuries and the likeliness of slight injuries was not affectd by the number of rotations. 

### Model assumptions Roach + severity injury class (with considering length if retained)

```{r}
# Check assumptions for multimod via logistic regressions
for (k in specieslist_OK){
  print(k)
  for (i in unique(df_OK_f_long_type$Injury)){
    print(paste(k,i))
    df_OK_f_long_type.temp<-df_OK_f_long_type[which(df_OK_f_long_type$Species==k),]
    df_OK_f_long_type.temp$nInjury=NA
    df_OK_f_long_type.temp$nInjury[which(df_OK_f_long_type.temp$Injury==i)]=1
    df_OK_f_long_type.temp$nInjury[which(df_OK_f_long_type.temp$Injury!=i)]=0
    model.assumptions<-log.model.state(nInjury ~ Pump_type_rpm * Length, df_OK_f_long_type.temp[which(df_OK_f_long_type.temp$Control=="pump"),],"simple",AIC=TRUE)
    df_OK_f_long_type.temp$pred=predict(model.assumptions,df_OK_f_long_type.temp,type="response")
    df_OK_f_long_type.temp$logit=log(df_OK_f_long_type.temp$pred/(1-df_OK_f_long_type.temp$pred))
  
    print(ggplot(df_OK_f_long_type.temp[which(df_OK_f_long_type.temp$Pump_type_rpm=="FNAFP 468"),], aes(Length,logit)) + geom_point(size = 0.5, alpha = 0.5) + geom_smooth(method = "loess") + theme_bw())
    print(ggplot(df_OK_f_long_type.temp[which(df_OK_f_long_type.temp$Pump_type_rpm=="FNAFP 550"),], aes(Length,logit)) + geom_point(size = 0.5, alpha = 0.5) + geom_smooth(method = "loess") + theme_bw())
  }
}
```

The model assumptions were met. 

#### Roach: severity injury class

```{r echo=FALSE}
k=1
sum.mult[[k]]$coefficients %>% kable(caption="Coefficients of the model for bream + severity injury class")
p_with_length[[k]] %>% kable(caption="p-values of the model for bream + severity injury class")
exp(coef(model.injury.df.multinom[[k]])) %>% kable(caption="Relative risk ratio (RR) for a one-unit increase in the considered variable to be identified as the considered class vs no injury. RR<1: Decrease of the probability of the considered factor versus the reference class (No injury). RR>1: Increase of the probability of the considered factor versus the reference class (No injury)")
```
Although for bream there was no significant difference between rotation regimes in the number of fish with no injuries, slight injuries or severe injuries, longer fish were significantly more likely to get severe and slight injuries. 

```{r fig.cap="Probability of type of injury occuring in function of length and screw type for roach"}
temp <- df_OK_f_long_type[which(df_OK_f_long_type$Control=="pump" & df_OK_f_long_type$Species=="roach"),] %>% tidyr::expand(Pump_type_rpm,full_seq(round(Length),1))
colnames(temp)[2] <- "Length"
temp.pp<-cbind(temp,predict(model.injury.df.multinom[[1]], newdata = temp, "probs"))
lpp <- melt(temp.pp, id.vars = c("Pump_type_rpm", "Length"), value.name = "probability")
a<-ggplot(lpp, aes(x = Length, y = probability, colour = Pump_type_rpm)) + geom_line(size=2) + facet_grid(variable ~., scales = "free") + theme_bw() + ylim(0,1)
a
pdf("./figures/manuscript/mult_model_roach_length_natural.pdf")
a
dev.off()
```

### Roach + injury class


### Roach + injury class (with considering length if retained)

```{r include=FALSE}
# multinom for injury OK
model.injury.df.multinom<-list()
k=0
sum.mult=list()
z=list()
p=list()
for(i in specieslist_OK){
  print(i)
  k=k+1
  form.state.df.multinom <- as.formula(Injury ~ Pump_type_rpm * Length)
  model.injury.df.multinom[[k]] <- stepAIC(multinom(formula = form.state.df.multinom, data = df_OK_f_long[which(df_OK_f_long$Control=="pump" & df_OK_f_long$Species==i),]))
 sum.mult[[k]]<-summary(model.injury.df.multinom[[k]])
  print(sum.mult[[k]])
  z[[k]] <- sum.mult[[k]]$coefficients/sum.mult[[k]]$standard.errors
  p[[k]] <- (1 - pnorm(abs(z[[k]]), 0, 1)) * 2
  print(p[[k]])
}
```

```{r echo=FALSE}
k=1
sum.mult[[k]]$coefficients %>% kable(caption="Coefficients of the model for bream + original injury class")
p[[k]] %>% kable(caption="p-values of the model for bream + original injury class")
exp(coef(model.injury.df.multinom[[k]])) %>% kable(caption="Relative risk ratio (RR) for a one-unit increase in the considered variable to be identified as the considered class vs no injury. RR<1: Decrease of the probability of the considered factor versus the reference class (No injury). RR>1: Increase of the probability of the considered factor versus the reference class (No injury)")
```

```{r}
k=1
emm_multinom1<-emmeans(model.injury.df.multinom[[k]], pairwise~Injury|Pump_type_rpm, type="response")
  print(emm_multinom1)
  emm_multinom1_plot_with_length[[k]]<-plot(emm_multinom1,PIs=FALSE,CI=TRUE,comparisons=FALSE,adjust="bonferroni",colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw(base_size=18)+xlab("Probability")+ylab("Injury")
  print(emm_multinom1_plot_with_length[[k]])
  
emm_multinom2_with_length[[k]]<-emmeans(model.injury.df.multinom[[k]], pairwise~Pump_type_rpm|Injury, type="response")
print(emm_multinom2_with_length[[k]])
emm_multinom2_plot_with_length[[k]]<-plot(emm_multinom2_with_length[[k]],PIs=FALSE,CI=TRUE,comparisons=FALSE,colors=c("black","#FF0000FF","#FF8000FF"))+theme_bw()+xlab("Probability")+ylab("Scenario")
print(emm_multinom2_plot_with_length[[k]])

pdf("./figures/manuscript/mult_model_roach_length_injury_natural.pdf",width=10,height=10)
ggarrange(emm_multinom1_plot_with_length[[1]],nrow=1,ncol=1,labels=c("Roach"))
dev.off()
```

```{r}
pdf("./figures/additional/mult_model_bream_roach_eel_length_natural_combo.pdf",width=8,height=8)
ggarrange(emm_multinom2_plot_with_length[[1]],a,nrow=2,ncol=1)
dev.off()
```

```{r fig.cap="Probability of type of injury occuring in function of length and screw type for roach"}
temp <- df_OK_f_long[which(df_OK_f_long$Control=="pump" & df_OK_f_long$Species=="roach"),] %>% tidyr::expand(Pump_type_rpm,full_seq(round(Length),1))
colnames(temp)[2] <- "Length"
temp.pp<-cbind(temp,predict(model.injury.df.multinom[[1]], newdata = temp, "probs"))
lpp <- melt(temp.pp, id.vars = c("Pump_type_rpm", "Length"), value.name = "probability")
a<-ggplot(lpp, aes(x = Length, y = probability, colour = Pump_type_rpm)) + geom_line(size=2) + facet_grid(variable ~., scales = "free") + theme_bw() + ylim(0,1)
a
pdf("./figures/manuscript/mult_model_roach_length_injury_natural2.pdf")
a
dev.off()
```