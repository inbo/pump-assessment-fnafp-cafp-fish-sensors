---
title: "bds_main"
author: "Stijn Bruneel"
date: "11-12-2022"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, echo=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r}
# import libraries from file
source("./source/not_functions/libraries.R")
source("./source/functions/correct_ROI_manually.R")
```

```{r}
if (file.exists("./data/bds/internal/Manually_changed_ROI.csv")) {
 unlink("./data/bds/internal/Manually_changed_ROI.csv")
 print("File is deleted..")
} else{
 print("File not exists..")
}
```

# Read in data, correct column names if necessary and rbind into 1 file

```{r}
if (file.exists("data/bds/internal/All_BDS_data_OK.csv")==FALSE){
  list.dir<-list.dirs(path = "./data/bds/external/")
  for (i in 2:length(list.dir)){
    list.file<-list.files(path=list.dir[[i]], pattern=".csv", all.files=TRUE,full.names=TRUE)
    for (j in 1:length(list.file)){
      file.temp<-read.csv(list.file[j])
      if (any(colnames(file.temp)=="Time..ms.")){colnames(file.temp)[which(names(file.temp) == "Time..ms.")] <- "Time..s."}
      if (any(colnames(file.temp)=="AX..m.s2.")){colnames(file.temp)[which(names(file.temp) == "AX..m.s2.")] <- "AXEarth..m.s2."}
      if (any(colnames(file.temp)=="AY..m.s2.")){colnames(file.temp)[which(names(file.temp) == "AY..m.s2.")] <- "AYEarth..m.s2."}
      if (any(colnames(file.temp)=="AZ..m.s2.")){colnames(file.temp)[which(names(file.temp) == "AZ..m.s2.")] <- "AZEarth..m.s2."}
      file.temp$scenario<-str_split(list.file[j],"/")[[1]][5]
      file.temp$sensor<-gsub(".csv","",str_split(list.file[j],"/")[[1]][6])
      file.temp$scenario_sensor<-paste(file.temp$scenario,file.temp$sensor,sep="/")
      if (j==1){file=file.temp} 
      if (j>1){file=smartbind(file,file.temp)}
    }
    if (i==2){file.complete=file} 
    if (i>2){file.complete=smartbind(file.complete,file)}
  }
  file.complete <- file.complete[which(file.complete$Time..s.<100),]
  write.csv(file.complete,"data/bds/internal/All_BDS_data_OK.csv")
} else {file.complete<-read.csv("data/bds/internal/All_BDS_data_OK.csv")}
rm(file.temp)
```

# Create new variables

To identify ROIs, the average pressure (average of the measurements in the three spatial dimensions) was used (unless explicitly mentioned otherwise).

```{r}
file.final <- file.complete

rm(file.complete)

file.final$scenario[which(file.final$scenario=="Old_Axial_n_6")]<-"Axial"
file.final$scenario[which(file.final$scenario=="Pump_40Hz_Control_n_13")]<-"F/N - 468 rpm Ctrl"
file.final$scenario[which(file.final$scenario=="Pump_40Hz_n_64")]<-"F/N - 468 rpm"
file.final$scenario[which(file.final$scenario=="Pump_47Hz_Control_n_15")]<-"F/N - 550 rpm Ctrl"
file.final$scenario[which(file.final$scenario=="Pump_47Hz_n_51")]<-"F/N - 550 rpm"


file.final$P..hPa.<-rowMeans(file.final[,c("PC..hPa.","PR..hPa.","PL..hPa.")],na.rm=TRUE)
  
file.final <- file.final %>%
  group_by(sensor) %>%                  
  mutate(diff_sec = P..hPa. - lag(P..hPa.,n=1),
         diff_sec_sgolayfilt = sgolayfilt(P..hPa.,2,11) - lag(sgolayfilt(P..hPa.,2,11),n=1),
         window.sd = rollapply(P..hPa.,11,sd,align='center',fill=NA)) %>% 
  ungroup()  
```

# Remove outliers

Outliers, measurements with an average pressure of 100.000 hPa, were removed. 

```{r}
file.final <- file.final[which(file.final$P..hPa.<10^5),]
```

# Overview of scenarios

```{r}
file.final %>% group_by(scenario) %>% distinct(scenario, sensor) %>% count() %>% kable(caption="Number of sensors per scenario")
```

# Check plots of total pressure in function of time

```{r}
scenario<-unique(file.final$scenario)
l <- list()
k = 0

for (s in scenario){
  file.final.scenario<-file.final[which(file.final$scenario==s),]
  sensors<-unique(file.final.scenario$sensor)
  for (i in sensors[1:5]){
    k = k+1
    file.final.sensor<-file.final.scenario[which(file.final.scenario$sensor==i),]
    g<-ggplot(file.final.sensor,aes(x=Time..s.,y=P..hPa.))+geom_line()+theme_minimal()+ggtitle(paste0(s,"/",i))
    l[[k]]<-ggplotly(g)
    rm(file.final.sensor)
  }
  rm(file.final.scenario)
}
l
```

# Check plots of acceleration (x-axis) in function of time

```{r}
scenario<-unique(file.final$scenario)
l <- list()
k = 0

for (s in scenario){
  file.final.scenario<-file.final[which(file.final$scenario==s),]
  sensors<-unique(file.final.scenario$sensor)
  for (i in sensors[1:5]){
    k = k+1
    file.final.sensor<-file.final.scenario[which(file.final.scenario$sensor==i),]
    g<-ggplot(file.final.sensor,aes(x=Time..s.,y=AXEarth..m.s2.))+geom_line()+theme_minimal()+ggtitle(paste0(s,"/",i))
    l[[k]]<-ggplotly(g)
    rm(file.final.sensor)
  }
  rm(file.final.scenario)
}
l
```

# Check plots of acceleration (y-axis) in function of time

```{r}
scenario<-unique(file.final$scenario)
l <- list()
k = 0

for (s in scenario){
  file.final.scenario<-file.final[which(file.final$scenario==s),]
  sensors<-unique(file.final.scenario$sensor)
  for (i in sensors[1:5]){
    k = k+1
    file.final.sensor<-file.final.scenario[which(file.final.scenario$sensor==i),]
    g<-ggplot(file.final.sensor,aes(x=Time..s.,y=AYEarth..m.s2.))+geom_line()+theme_minimal()+ggtitle(paste0(s,"/",i))
    l[[k]]<-ggplotly(g)
    rm(file.final.sensor)
  }
  rm(file.final.scenario)
}
l
```

# Check plots of acceleration (z-axis) in function of time

```{r}
scenario<-unique(file.final$scenario)
l <- list()
k = 0

for (s in scenario){
  file.final.scenario<-file.final[which(file.final$scenario==s),]
  sensors<-unique(file.final.scenario$sensor)
  for (i in sensors[1:5]){
    k = k+1
    file.final.sensor<-file.final.scenario[which(file.final.scenario$sensor==i),]
    g<-ggplot(file.final.sensor,aes(x=Time..s.,y=AZEarth..m.s2.))+geom_line()+theme_minimal()+ggtitle(paste0(s,"/",i))
    l[[k]]<-ggplotly(g)
    rm(file.final.sensor)
  }
  rm(file.final.scenario)
}
l
```

# Determine the moment of injection

The moment of injection was the first moment in time at which all three pressure measurements were higher than 1005 hPa.  

```{r}
file.final.injection <- file.final %>%                                
  group_by(sensor) %>%                  
  filter(PL..hPa. > 1005 & PC..hPa. > 1005 & PR..hPa. > 1005) %>%  
  slice(1) %>%                       
  ungroup()  

file.final.injection$stage <- 'injection'
```

# Assess whether there are any sensors that were not given an injection moment

Due to faulty PL measurements, 5 sensors were not assigned a moment of injection. 

```{r}
sensors.without.injection <- unique(file.final$sensor)[which(unique(file.final$sensor) %in% unique(file.final.injection$sensor)==FALSE)]
sensors.without.injection

if (length(sensors.without.injection)>=1){

  for (i in sensors.without.injection){
    file.final.temp<-file.final[which(file.final$sensor==i),]
    g<-ggplot(file.final.temp,aes(x=Time..s.,y=P..hPa.))+geom_line()+theme_minimal()+ggtitle(i)
    print(g)
    rm(file.final.temp)
  }
  
  file.final.injection.extra <- file.final %>%  
    filter(sensor %in% sensors.without.injection) %>% 
    group_by(sensor) %>%                  
    filter(PC..hPa. > 1005 & PR..hPa. > 1005) %>%  
    slice(1) %>%                       
    ungroup() 
  
  file.final.injection.extra$stage <- 'injection'
  
  file.final.injection <- rbind(file.final.injection,file.final.injection.extra)
  
  sensors.without.injection <- unique(file.final$sensor)[which(unique(file.final$sensor) %in% unique(file.final.injection$sensor)==FALSE)]
  print(sensors.without.injection)
  
  rm(sensors.without.injection,file.final.injection.extra)
}
```

# Assess whether the moment of injection is correct for all sensors and if not: correct

For these sensors without injection, the PL measurements were not considered when identifying the injection. After visual inspection all assigned injections were appropriately identified.

```{r}
sensors.with.unlikely.injection <- unique(file.final.injection$sensor[which(file.final.injection$Time..s.>100)])
sensors.with.unlikely.injection

if (length(sensors.with.unlikely.injection)>=1){

  file.final.injection.extra <- file.final %>%  
    filter(sensor %in% sensors.with.unlikely.injection) %>% 
    group_by(sensor) %>%                  
    filter(PC..hPa. > 1005 & PR..hPa. > 1005) %>%  
    slice(1) %>%                       
    ungroup() 
  
  file.final.injection.extra$stage <- 'injection'
  
  file.final.injection <- file.final.injection[-which(file.final.injection$sensor %in% unique(file.final.injection.extra$sensor)),]
  
  file.final.injection <- rbind(file.final.injection,file.final.injection.extra)
  
  sensors.with.unlikely.injection <- unique(file.final.injection$sensor[which(file.final.injection$Time..s.>100)])
  print(sensors.with.unlikely.injection)

  rm(file.final.injection.extra,sensors.with.unlikely.injection)
}
```

# Determine the moment of nadir pressure

The nadir was determined differently for control and not-control sensors. For the non-control samples the nadir should be located within 3 and 75 seconds after the moment of injection. As the nadir is characterized by a sudden pressure change the relative change in average pressure should also be considered. To this end, a Savitzky-Golay smoothing filter was applied to the average pressure data over time with a filter polynomial order of 2 and frame length of 11. The nadir should be close in time (<0.1 seconds) to an absolute change in smoothed average pressure of minimally 20 hPa. The lowest value to meet these requirements was identified as the nadir. For the control samples, the nadir should be located within 5 and 75 seconds after the moment of injection. There was no requirement to smooth the data for the control samples and the lowest pressure was retained as the nadir. After visual inspection, no correction needed to be made for the nadir as all appeared to be identified correctly using these rules.

```{r}
sensors<-unique(file.final$sensor)
file.final$time.of.injection<-NA
file.final$relative.to.injection<-NA

for (i in sensors){
  time.of.injection<-file.final.injection$Time..s.[which(file.final.injection$sensor==i)]
  file.final$time.of.injection[which(file.final$sensor==i)]<-time.of.injection
  file.final$relative.to.injection[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.injection
}

file.final.nadir.pressure <- file.final %>%
  group_by(sensor) %>%
  mutate(NadirNearby=case_when(str_detect(scenario,"Ctrl")==FALSE & relative.to.injection > 3
                   & relative.to.injection < 75
                   & abs(diff_sec_sgolayfilt) > 20 ~ TRUE,
                   str_detect(scenario,"Ctrl")==TRUE & relative.to.injection > 5
                   & relative.to.injection < 75 ~ TRUE, .default=FALSE)) %>%
  mutate(diff_nadir = map_dbl(Time..s., ~ min(abs(.x - Time..s.[NadirNearby])))) %>%
  filter(diff_nadir<10*0.01) %>%
  filter(P..hPa.==min(P..hPa.)) %>%
  slice(1) %>%
  select(-c(diff_nadir, NadirNearby)) %>%
  ungroup()

file.final.nadir.pressure<-correct_ROI_manually(file.final.nadir.pressure,"B470904140250",20.165,"nadir_pressure")

file.final.nadir.pressure$relative.to.injection<-NULL
file.final.nadir.pressure$time.of.injection<-NULL
file.final$relative.to.injection<-NULL

file.final.nadir.pressure$stage <- 'nadir_pressure'

rm(time.of.injection)
```

```{r}
file.final$local_maxima_P <- NA
file.final$local_minima_P<- NA
file.final$local_maxima_P[which(diff(sign(diff(file.final$P..hPa.)))==-2)+1] <- TRUE
file.final$local_minima_P[which(diff(sign(diff(file.final$P..hPa.)))==2)+1] <- TRUE

file.final$local_maxima_AX <- NA
file.final$local_minima_AX<- NA
file.final$local_maxima_AX[which(diff(sign(diff(file.final$AXEarth..m.s2.)))==-2)+1] <- TRUE
file.final$local_maxima_AX[which(file.final$local_maxima_AX==TRUE & abs(file.final$AXEarth..m.s2.)<25)] <-NA
file.final$local_minima_AX[which(diff(sign(diff(file.final$AXEarth..m.s2.)))==2)+1] <- TRUE
file.final$local_minima_AX[which(file.final$local_minima_AX==TRUE & abs(file.final$AXEarth..m.s2.)<25)] <-NA

file.final$local_maxima_AY <- NA
file.final$local_minima_AY<- NA
file.final$local_maxima_AY[which(diff(sign(diff(file.final$AYEarth..m.s2.)))==-2)+1] <- TRUE
file.final$local_maxima_AY[which(file.final$local_maxima_AY==TRUE & abs(file.final$AYEarth..m.s2.)<25)] <-NA
file.final$local_minima_AY[which(diff(sign(diff(file.final$AYEarth..m.s2.)))==2)+1] <- TRUE
file.final$local_minima_AY[which(file.final$local_minima_AY==TRUE & abs(file.final$AYEarth..m.s2.)<25)] <-NA

file.final$local_maxima_AZ <- NA
file.final$local_minima_AZ<- NA
file.final$local_maxima_AZ[which(diff(sign(diff(file.final$AZEarth..m.s2.)))==-2)+1] <- TRUE
file.final$local_maxima_AZ[which(file.final$local_maxima_AZ==TRUE & abs(file.final$AZEarth..m.s2.)<25)] <-NA
file.final$local_minima_AZ[which(diff(sign(diff(file.final$AZEarth..m.s2.)))==2)+1] <- TRUE
file.final$local_minima_AZ[which(file.final$local_minima_AZ==TRUE & abs(file.final$AZEarth..m.s2.)<25)] <-NA
```

# Determine P0

```{r}
sensors<-unique(file.final$sensor)
file.final$time.of.nadir<-NA
file.final$relative.to.nadir<-NA
file.final$time.of.injection<-NA
file.final$relative.to.injection<-NA

for (i in sensors){
  time.of.nadir<-file.final.nadir.pressure$Time..s.[which(file.final.nadir.pressure$sensor==i)]
  file.final$time.of.nadir[which(file.final$sensor==i)]<-time.of.nadir
  file.final$relative.to.nadir[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.nadir
  time.of.injection<-file.final.injection$Time..s.[which(file.final.injection$sensor==i)]
  file.final$time.of.injection[which(file.final$sensor==i)]<-time.of.injection
  file.final$relative.to.injection[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.injection
}

# x mbar crossing for pressure, AFTER injection event
file.final.P0 <- file.final %>%
  group_by(sensor) %>%
  filter((scenario=="Axial" & P..hPa.>1050 & relative.to.injection > 50*0.01)| # 1050 mbar crossing for pressure, AFTER injection event
         (scenario=="F/N - 468 rpm" & P..hPa.>1050 & relative.to.injection > 50*0.01)| # 1050 mbar crossing for pressure, AFTER injection event
         (scenario=="F/N - 550 rpm" & P..hPa.>1050 & relative.to.injection > 50*0.01)| # 1050 mbar crossing for pressure, AFTER injection event
         (scenario=="F/N - 468 rpm Ctrl" & P..hPa.>1070 & relative.to.injection > 50*0.01)| # 1070 mbar crossing for pressure, AFTER injection event
         (scenario=="F/N - 550 rpm Ctrl" & P..hPa.>1070 & relative.to.injection > 50*0.01)) %>% # 1070 mbar crossing for pressure, AFTER injection event
  filter(Time..s.==min(Time..s.)) %>%
  slice(1) %>%
  ungroup()
file.final.P0$stage<-"P0"
```

# Determine P1

```{r}
file.final$time.of.P0<-NA
file.final$relative.to.P0<-NA

for (i in sensors){
  time.of.P0<-file.final.P0$Time..s.[which(file.final.P0$sensor==i)]
  if (is_empty(time.of.P0)==TRUE){time.of.P0<-NA}
  file.final$time.of.P0[which(file.final$sensor==i)]<-time.of.P0
  file.final$relative.to.P0[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.P0
}

file.final.P1 <- file.final %>%                                
  group_by(sensor) %>%
  filter((scenario=="Axial" & relative.to.nadir>(-100*0.01) & relative.to.nadir<0)| # Pressure maxima between the moment of nadir and one second before the moment of nadir
         (scenario=="F/N - 468 rpm" & relative.to.nadir>(-100*0.01) & relative.to.nadir<0)| # Pressure maxima between the moment of nadir and one second before the moment of nadir
         (scenario=="F/N - 550 rpm" & relative.to.nadir>(-100*0.01) & relative.to.nadir<0)) %>% # Pressure maxima between the moment of nadir and one second before the moment of nadir
  filter(P..hPa.==max(P..hPa.)) %>%  
  filter(Time..s.==max(Time..s.)) %>%  
  slice(1) %>%
  ungroup() 
file.final.P1$stage<-"P1"
```

# Determine P2

```{r}
file.final$time.of.P1<-NA
file.final$relative.to.P1<-NA

for (i in sensors){
  time.of.P1<-file.final.P1$Time..s.[which(file.final.P1$sensor==i)]
  if (is_empty(time.of.P1)==TRUE){time.of.P1<-NA}
  file.final$time.of.P1[which(file.final$sensor==i)]<-time.of.P1
  file.final$relative.to.P1[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.P1
}

file.final.P2 <- file.final %>%                                
  group_by(sensor) %>%
  filter((scenario=="Axial" & relative.to.nadir<(100*0.01) & relative.to.nadir>0)| #maxima immediately after blade nadir
         (scenario=="F/N - 468 rpm" & relative.to.nadir<(100*0.01) & relative.to.nadir>0)| # maxima immediately after blade nadir
         (scenario=="F/N - 550 rpm" & relative.to.nadir<(100*0.01) & relative.to.nadir>0)) %>% # maxima immediately after blade nadir
  filter(P..hPa.==max(P..hPa.)) %>% 
  filter(Time..s.==min(Time..s.)) %>%  
  slice(1) %>%
  ungroup() 

file.final.P2<-correct_ROI_manually(file.final.P2,"B481212161232",18.156,"P2")

file.final.P2$stage<-"P2"
```

# Determine P3

```{r}
file.final$time.of.P2<-NA
file.final$relative.to.P2<-NA

for (i in sensors){
  time.of.P2<-file.final.P2$Time..s.[which(file.final.P2$sensor==i)]
  if (is_empty(time.of.P2)==TRUE){time.of.P2<-NA}
  file.final$time.of.P2[which(file.final$sensor==i)]<-time.of.P2
  file.final$relative.to.P2[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.P2
}

file.final.P3 <- file.final %>%                                
  group_by(sensor) %>%
  filter((scenario=="Axial" & relative.to.P2<(100*0.01) & relative.to.P2>0)| # minima immediately after second local maxima (P2)
         (scenario=="F/N - 468 rpm" & relative.to.P2<(100*0.01) & relative.to.P2>0)| # minima immediately after second local maxima (P2)
         (scenario=="F/N - 550 rpm" & relative.to.P2<(100*0.01) & relative.to.P2>0)) %>% # minima immediately after second local maxima (P2)
  filter(P..hPa.==min(P..hPa.)) %>% 
  filter(Time..s.==min(Time..s.)) %>%  
  slice(1) %>%
  ungroup() 
file.final.P3$stage<-"P3"
```

# Determine P4

```{r}
file.final$time.of.P3<-NA
file.final$relative.to.P3<-NA

for (i in sensors){
  time.of.P3<-file.final.P3$Time..s.[which(file.final.P3$sensor==i)]
  if (is_empty(time.of.P3)==TRUE){time.of.P3<-NA}
  file.final$time.of.P3[which(file.final$sensor==i)]<-time.of.P3
  file.final$relative.to.P3[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.P3
}

file.final.P4 <- file.final %>%                                
  group_by(sensor) %>%
  filter((scenario=="Axial" & relative.to.P3 < (1500*0.01) & relative.to.P3 > 0)| # Local maxima of the control region, as sensor passes into the cage / net
         (scenario=="F/N - 468 rpm" & relative.to.P3 < (1500*0.01) & relative.to.P3 > 0)| # Local maxima of the control region, as sensor passes into the cage / net
         (scenario=="F/N - 550 rpm" & relative.to.P3 < (1500*0.01) & relative.to.P3 > 0)) %>% # Local maxima of the control region, as sensor passes into the cage / net
  filter(P..hPa.==max(P..hPa.)) %>% 
  filter(Time..s.==min(Time..s.)) %>%  
  slice(1) %>%
  ungroup() 

file.final.P4<-correct_ROI_manually(file.final.P4,"B451212140030",18.377,"P4")
file.final.P4<-correct_ROI_manually(file.final.P4,"B261212160554",19.437,"P4")
file.final.P4<-correct_ROI_manually(file.final.P4,"B771212142232",37.692,"P4")

file.final.P4$stage<-"P4"

file.final.P4_control <- file.final %>%                                
  group_by(sensor) %>%
  filter((scenario=="F/N - 468 rpm Ctrl" & relative.to.nadir < 2000*0.01 & relative.to.nadir > 0)| # Peak pressure after P0
         (scenario=="F/N - 550 rpm Ctrl" & relative.to.nadir < 2000*0.01 & relative.to.nadir > 0)) %>% # Peak pressure after P0
  filter(P..hPa.==max(P..hPa.)) %>% 
  filter(Time..s.==max(Time..s.)) %>%  
  slice(1) %>%
  ungroup() 
file.final.P4_control$stage<-"P4"

file.final.P4<-rbind(file.final.P4,file.final.P4_control)

file.final$time.of.P4<-NA
file.final$relative.to.P4<-NA
for (i in sensors){
  time.of.P4<-file.final.P4$Time..s.[which(file.final.P4$sensor==i)]
  if (is_empty(time.of.P4)==TRUE){time.of.P4<-NA}
  file.final$time.of.P4[which(file.final$sensor==i)]<-time.of.P4
  file.final$relative.to.P4[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.P4
}
```

# Determine P5

```{r eval=FALSE}
file.final$time.of.P4<-NA
file.final$relative.to.P4<-NA

for (i in sensors){
  time.of.P4<-file.final.P4$Time..s.[which(file.final.P4$sensor==i)]
  if (is_empty(time.of.P4)==TRUE){time.of.P4<-NA}
  file.final$time.of.P4[which(file.final$sensor==i)]<-time.of.P4
  file.final$relative.to.P4[which(file.final$sensor==i)]<-file.final$Time..s.[which(file.final$sensor==i)]-time.of.P4
}

file.final.P5 <- file.final %>%                                
  group_by(sensor) %>%
  filter((scenario=="Axial" & local_minima_P==TRUE & relative.to.P4>(1000*0.01))| # Pressure minima after peak, indicating the sensor is now in the cage, net or tailwater
         (scenario=="F/N - 468 rpm" & local_minima_P==TRUE & relative.to.P4>(1000*0.01))| # Pressure minima after peak, indicating the sensor is now in the cage, net or tailwater
         (scenario=="F/N - 550 rpm" & local_minima_P==TRUE & relative.to.P4>(1000*0.01))| # Pressure minima after peak, indicating the sensor is now in the cage, net or tailwater
         (scenario=="F/N - 468 rpm Ctrl" & local_minima_P==TRUE & relative.to.P4>(2000*0.01))| # Pressure minima after peak, indicating the sensor is now in the cage, net or tailwater
         (scenario=="F/N - 550 rpm Ctrl" & local_minima_P==TRUE & relative.to.P4>(2000*0.01))) %>% # Pressure minima after peak, indicating the sensor is now in the cage, net or tailwater
  filter(Time..s.==min(Time..s.)) %>%  
  slice(1) %>%
  ungroup() 
file.final.P5$stage<-"P5"
```

# Combine P0, P1, P2, P3 and P4

```{r}
file.final.P<-bind_rows(file.final.P0,file.final.P1,file.final.P2,file.final.P3,file.final.P4)

rm(file.final.P0,file.final.P1,file.final.P2,file.final.P3,file.final.P4,file.final.P4_control)
```

# Determine the moment of exit

```{r}
file.final.exit <-  file.final %>% 
  filter((Time..s. > time.of.injection) & (Time..s. < (time.of.injection + 70))) %>% 
  group_by(sensor) %>%   
  slice(which.min(window.sd)) %>%                       
  ungroup()  

file.final.exit$stage <- 'exit'
```

# Plot the timeseries with indication of the different ROI

```{r}
file.final.injection.nadir<-bind_rows(file.final.injection,file.final.nadir.pressure,file.final.exit,file.final.P)

rm(file.final.injection,file.final.nadir.pressure,file.final.exit,file.final.P)
```

```{r}
file.final.injection.nadir.wide <- file.final.injection.nadir[,c("scenario","sensor","scenario_sensor","stage","Time..s.","P..hPa.")] %>%
    pivot_wider(names_from = stage, values_from = c("Time..s.","P..hPa."))
```

```{r}
file.final.injection.nadir$line_type=NA
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="injection")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="nadir_pressure")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="exit")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="P0")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="P1")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="P2")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="P3")]='solid'
file.final.injection.nadir$line_type[which(file.final.injection.nadir$stage=="P4")]='solid'
file.final.injection.nadir$color=NA
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="injection")]='yellow'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="nadir_pressure")]='green'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="exit")]='orange'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="P0")]='lightblue'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="P1")]='blue'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="P2")]='darkblue'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="P3")]='purple'
file.final.injection.nadir$color[which(file.final.injection.nadir$stage=="P4")]='red'


scenario<-unique(file.final$scenario)
l <- list()
k = 0
for (s in scenario){
  file.final.scenario<-file.final[which(file.final$scenario==s),]
  sensors<-unique(file.final.scenario$sensor)
  for (i in sensors[1:5]){
    k=k+1
    file.final.sensor<-file.final.scenario[which(file.final.scenario$sensor==i),]
    g<-ggplot(file.final.sensor,aes(x=Time..s.,y=P..hPa.))+geom_line()+theme_minimal()
    g<-g+geom_vline(aes(xintercept = Time..s., color = stage, linetype = stage), file.final.injection.nadir[which(file.final.injection.nadir$sensor==i),], size = 1)
    g<-g+scale_colour_manual(values = file.final.injection.nadir$color[which(file.final.injection.nadir$sensor==i)]) 
    g<-g+scale_linetype_manual(values = file.final.injection.nadir$line_type[which(file.final.injection.nadir$sensor==i)])
    g<-g+xlim(0,80)+ggtitle(paste0(s,"/",i))
    l[[k]]<-ggplotly(g)
    rm(file.final.sensor)
  }
  rm(file.final.scenario)
}
l
```

```{r}
write.csv(file.final,"data/bds/internal/All_BDS_data_final_OK.csv")
write.csv(file.final.injection.nadir.wide,"data/bds/internal/All_BDS_data_ROIs_OK.csv")
write.csv(file.final.injection.nadir,"data/bds/internal/All_BDS_data_ROIs_OK_long.csv")
```

