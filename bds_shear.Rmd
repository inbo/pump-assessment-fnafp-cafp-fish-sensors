---
title: "bds_shear"
author: "Sarah Broos"
date: "2024-09-30"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, echo=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r}
# import libraries from file
source("./source/not_functions/libraries.R")
source("./source/functions/correct_ROI_manually.R")
```

```{r}
if (file.exists("./data/bds/internal/Manually_changed_ROI.csv")) {
 unlink("./data/bds/internal/Manually_changed_ROI.csv")
 print("File is deleted..")
} else{
 print("File not exists..")
}
```

# Read in data, correct column names if necessary and rbind into 1 file

```{r}
if (file.exists("data/bds/internal/All_BDS_data_OK.csv")==FALSE){
  list.dir<-list.dirs(path = "./data/bds/external/")
  for (i in 2:length(list.dir)){
    list.file<-list.files(path=list.dir[[i]], pattern=".csv", all.files=TRUE,full.names=TRUE)
    for (j in 1:length(list.file)){
      file.temp<-read.csv(list.file[j])
      if (any(colnames(file.temp)=="Time..ms.")){colnames(file.temp)[which(names(file.temp) == "Time..ms.")] <- "Time..s."}
      if (any(colnames(file.temp)=="AX..m.s2.")){colnames(file.temp)[which(names(file.temp) == "AX..m.s2.")] <- "AXEarth..m.s2."}
      if (any(colnames(file.temp)=="AY..m.s2.")){colnames(file.temp)[which(names(file.temp) == "AY..m.s2.")] <- "AYEarth..m.s2."}
      if (any(colnames(file.temp)=="AZ..m.s2.")){colnames(file.temp)[which(names(file.temp) == "AZ..m.s2.")] <- "AZEarth..m.s2."}
      file.temp$scenario<-str_split(list.file[j],"/")[[1]][5]
      file.temp$sensor<-gsub(".csv","",str_split(list.file[j],"/")[[1]][6])
      file.temp$scenario_sensor<-paste(file.temp$scenario,file.temp$sensor,sep="/")
      if (j==1){file=file.temp} 
      if (j>1){file=smartbind(file,file.temp)}
    }
    if (i==2){file.complete=file} 
    if (i>2){file.complete=smartbind(file.complete,file)}
  }
  file.complete <- file.complete[which(file.complete$Time..s.<100),]
  write.csv(file.complete,"data/bds/internal/All_BDS_data_OK.csv")
} else {file.complete<-read.csv("data/bds/internal/All_BDS_data_OK.csv")}
rm(file.temp)
```

#add column Δ P
added column Plc and Prc, this are the absolute values of the difference between the left and central pressure sensor and the right and central pressure sensor respectivecly. 

```{r}
file.final <- file.complete

rm(file.complete)

file.final$scenario[which(file.final$scenario=="Old_Axial_n_6")]<-"CAFP"
file.final$scenario[which(file.final$scenario=="Pump_40Hz_Control_n_13")]<-"FNAFP - 468 rpm Ctrl"
file.final$scenario[which(file.final$scenario=="Pump_40Hz_n_64")]<-"FNAFP - 468 rpm"
file.final$scenario[which(file.final$scenario=="Pump_47Hz_Control_n_15")]<-"FNAFP - 550 rpm Ctrl"
file.final$scenario[which(file.final$scenario=="Pump_47Hz_n_51")]<-"FNAFP - 550 rpm"

#add columns Δ P
file.final$P..hPa.<-rowMeans(file.final[,c("PC..hPa.","PR..hPa.","PL..hPa.")],na.rm=TRUE)
file.final$Plc..hPa.<-abs(file.final$PC..hPa. - file.final$PL..hPa.)
file.final$Prc..hPa.<-abs(file.final$PC..hPa. - file.final$PR..hPa.)



file.final <- file.final %>%
  group_by(sensor) %>%                  
  mutate(diff_sec = P..hPa. - lag(P..hPa.,n=1),
         diff_sec_sgolayfilt = sgolayfilt(P..hPa.,2,11) - lag(sgolayfilt(P..hPa.,2,11),n=1),
         window.sd = rollapply(P..hPa.,11,sd,align='center',fill=NA)) %>% 
  ungroup()  
```

# Overview of scenarios

```{r}
file.final %>% group_by(scenario) %>% distinct(scenario, sensor) %>% count() %>% kable(caption="Number of sensors per scenario")
```


# Determine the moment of injection

The moment of injection was the first moment in time at which all three pressure measurements were higher than 1005 hPa.  

```{r}
file.final.injection <- file.final %>%                                
  group_by(sensor) %>%                  
  filter(PL..hPa. > 1005 & PC..hPa. > 1005 & PR..hPa. > 1005) %>%  
  slice(1) %>%                       
  ungroup()  

file.final.injection$stage <- 'injection'
```

# Assess whether there are any sensors that were not given an injection moment

Due to faulty PL measurements, 5 sensors were not assigned a moment of injection. 

```{r}
sensors.without.injection <- unique(file.final$sensor)[which(unique(file.final$sensor) %in% unique(file.final.injection$sensor)==FALSE)]
sensors.without.injection

if (length(sensors.without.injection)>=1){

  for (i in sensors.without.injection){
    file.final.temp<-file.final[which(file.final$sensor==i),]
    g<-ggplot(file.final.temp,aes(x=Time..s.,y=P..hPa.))+geom_line()+theme_minimal()+ggtitle(i)
    print(g)
    rm(file.final.temp)
  }
  
  file.final.injection.extra <- file.final %>%  
    filter(sensor %in% sensors.without.injection) %>% 
    group_by(sensor) %>%                  
    filter(PC..hPa. > 1005 & PR..hPa. > 1005) %>%  
    slice(1) %>%                       
    ungroup() 
  
  file.final.injection.extra$stage <- 'injection'
  
  file.final.injection <- rbind(file.final.injection,file.final.injection.extra)
  
  sensors.without.injection <- unique(file.final$sensor)[which(unique(file.final$sensor) %in% unique(file.final.injection$sensor)==FALSE)]
  print(sensors.without.injection)
  
  rm(sensors.without.injection,file.final.injection.extra)
}
```

# Assess whether the moment of injection is correct for all sensors and if not: correct

For these sensors without injection, the PL measurements were not considered when identifying the injection. After visual inspection all assigned injections were appropriately identified.

```{r}
sensors.with.unlikely.injection <- unique(file.final.injection$sensor[which(file.final.injection$Time..s.>100)])
sensors.with.unlikely.injection

if (length(sensors.with.unlikely.injection)>=1){

  file.final.injection.extra <- file.final %>%  
    filter(sensor %in% sensors.with.unlikely.injection) %>% 
    group_by(sensor) %>%                  
    filter(PC..hPa. > 1005 & PR..hPa. > 1005) %>%  
    slice(1) %>%                       
    ungroup() 
  
  file.final.injection.extra$stage <- 'injection'
  
  file.final.injection <- file.final.injection[-which(file.final.injection$sensor %in% unique(file.final.injection.extra$sensor)),]
  
  file.final.injection <- rbind(file.final.injection,file.final.injection.extra)
  
  sensors.with.unlikely.injection <- unique(file.final.injection$sensor[which(file.final.injection$Time..s.>100)])
  print(sensors.with.unlikely.injection)

  rm(file.final.injection.extra,sensors.with.unlikely.injection)
}
```

#Shear stress threshold value
Based on literature we know U needs to be between 5 and 15m/s? Therefore we made an Threshold value based on 5, 10 and 15 m/s. For the creation of the threshold value we made use of (url to Jeff's Github for excel file). 
In this excel file we used the T on the 12/12/2018 and 13/12/2018, which is 4,5°C (see paper)

The threshold (ε ≥ 500 s-1) for ΔP at 4,5 °C and:
U = 5m/s: ΔP = 3,45 hPa
U = 10m/s: ΔP = 4,86 hPa
U = 15m/s: ΔP = 5,95 hPa





# Check plots of Plc and Prc in function of time with the threshold values

```{r}
scenario<-unique(file.final$scenario)
l <- list()
k = 0

# Define the threshold value in hPa
th5<-3.45
th10<-4.86
th15<-5.95



for (s in scenario){
  file.final.scenario<-file.final[which(file.final$scenario==s),]
  sensors<-unique(file.final.scenario$sensor)
  for (i in sensors[1:5]){
    k = k+1
    file.final.sensor<-file.final.scenario[which(file.final.scenario$sensor==i),]
    #create plot with 2 lines one for Plc and one for Prc
     g <- ggplot(file.final.sensor, aes(x = Time..s.)) +
            geom_line(aes(y = P..hPa., color = "P")) +   # Total pressure
            geom_line(aes(y = Plc..hPa., color = "Plc")) +   # First line for Plc
            geom_line(aes(y = Prc..hPa., color = "Prc")) +   # Second line for Prc
            geom_hline(yintercept = th5, linetype = "dashed", color = "black", aes(label = "U = 5 m/s")) +  # Threshold line 5 m/s
            geom_hline(yintercept = th5, linetype = "dashed", color = "black", aes(label = "U = 10 m/s")) +  # Threshold line U = 10 m/s
            geom_hline(yintercept = th5, linetype = "dashed", color = "black", aes(label = "U = 15 m/s")) +  # Threshold line U = 15 m/s
            theme_minimal() +
            ggtitle(paste0(s, "/", i)) +
            scale_color_manual(name = "Legend", values = c("Plc" = "blue", "Prc" = "red", "th5" = "black", "th10" = "black","th15" = "black", "P" = "black"))  # Custom colors for each line
    l[[k]]<-ggplotly(g)
    rm(file.final.sensor)
  }
  rm(file.final.scenario)
}
l
```

```{r}
scenario <- unique(file.final$scenario)
l <- list()
k = 0

# Define the threshold value
threshold <- 3.45

for (s in scenario){
  file.final.scenario <- file.final[which(file.final$scenario == s), ]
  sensors <- unique(file.final.scenario$sensor)
  
  for (i in sensors[1:5]){
    k = k + 1
    file.final.sensor <- file.final.scenario[which(file.final.scenario$sensor == i), ]
    
    # Create a plot with two lines, one for Plc and another for Prc
    g <- ggplot(file.final.sensor, aes(x = Time..s.)) +
            geom_line(aes(y = Plc..hPa., color = "Plc")) +   # First line for Plc
            geom_line(aes(y = Prc..hPa., color = "Prc")) +   # Second line for Prc
            geom_hline(yintercept = threshold, linetype = "dashed", color = "black", aes(label = "U = 5 m/s")) +  # Threshold line
            theme_minimal() +
            ggtitle(paste0(s, "/", i)) +
            scale_color_manual(name = "Legend", values = c("Plc" = "blue", "Prc" = "red"))  # Custom colors for each line
    
    l[[k]] <- ggplotly(g)
    
    # Calculate the time for which Prc exceeds the threshold
    prc_over_threshold <- file.final.sensor$Prc..hPa. > threshold
    time_above_threshold <- sum(diff(file.final.sensor$Time..s.)[prc_over_threshold[-1]])  # Summing the time differences where Prc is above threshold
    
    print(paste0("Sensor: ", i, " for Scenario: ", s, " exceeds threshold for ", time_above_threshold, " seconds."))
    
    rm(file.final.sensor)
  }
  
  rm(file.final.scenario)
}

```
```{r}
scenario <- unique(file.final$scenario)
l <- list()
k = 0

# Define the threshold value
threshold <- 3.45

# Dataframe to store results
over_threshold_df <- data.frame(Scenario = character(),
                                Sensor = character(),
                                Start_Time = numeric(),
                                End_Time = numeric(),
                                Duration = numeric(),
                                Avg_Prc = numeric(),
                                Max_Prc = numeric(),
                                stringsAsFactors = FALSE)

for (s in scenario){
  file.final.scenario <- file.final[which(file.final$scenario == s), ]
  sensors <- unique(file.final.scenario$sensor)
  
  for (i in sensors[1:5]){
    k = k + 1
    file.final.sensor <- file.final.scenario[which(file.final.scenario$sensor == i), ]
    
    # Create a plot with two lines, one for Plc and another for Prc
    g <- ggplot(file.final.sensor, aes(x = Time..s.)) +
            geom_line(aes(y = Plc..hPa., color = "Plc")) +   # First line for Plc
            geom_line(aes(y = Prc..hPa., color = "Prc")) +   # Second line for Prc
            geom_hline(yintercept = threshold, linetype = "dashed", color = "black") +  # Threshold line
            theme_minimal() +
            ggtitle(paste0(s, "/", i)) +
            scale_color_manual(name = "Legend", values = c("Plc" = "blue", "Prc" = "red"))  # Custom colors for each line
    
    l[[k]] <- ggplotly(g)
    
    # Identify where Prc exceeds the threshold
    prc_above_threshold <- file.final.sensor$Prc..hPa. > threshold
    
    # Find the start and end of each "over-threshold" period
    diff_prc <- c(FALSE, diff(prc_above_threshold) != 0)  # Detect changes in the logical vector
    event_starts <- which(diff_prc & prc_above_threshold)
    event_ends <- which(diff_prc & !prc_above_threshold) - 1
    
    # Handle if the period continues till the last row
    if (length(event_starts) > length(event_ends)) {
      event_ends <- c(event_ends, nrow(file.final.sensor))
    }
    
    # Loop through each "over-threshold" period
    for (j in 1:length(event_starts)) {
      start_idx <- event_starts[j]
      end_idx <- event_ends[j]
      
      # Get the time range
      start_time <- file.final.sensor$Time..s.[start_idx]
      end_time <- file.final.sensor$Time..s.[end_idx]
      duration <- end_time - start_time
      
      # Calculate average and maximum Prc during the over-threshold period
      avg_prc <- mean(file.final.sensor$Prc..hPa.[start_idx:end_idx], na.rm = TRUE)
      max_prc <- max(file.final.sensor$Prc..hPa.[start_idx:end_idx], na.rm = TRUE)
      
      # Append the result to the dataframe
      over_threshold_df <- rbind(over_threshold_df, data.frame(Scenario = s,
                                                               Sensor = i,
                                                               Start_Time = start_time,
                                                               End_Time = end_time,
                                                               Duration = duration,
                                                               Avg_Prc = avg_prc,
                                                               Max_Prc = max_prc,
                                                               stringsAsFactors = FALSE))
    }
    
    rm(file.final.sensor)
  }
  
  rm(file.final.scenario)
}

# Print the over-threshold dataframe
print(over_threshold_df)



```

```{r}
scenario <- unique(file.final$scenario)
l <- list()
k = 0

# Define the threshold value
threshold <- 3.45

for (s in scenario) {
  file.final.scenario <- file.final[which(file.final$scenario == s), ]
  sensors <- unique(file.final.scenario$sensor)
  
  for (i in sensors[1:5]) {
    k = k + 1
    file.final.sensor <- file.final.scenario[which(file.final.scenario$sensor == i), ]
    
    # Create a plot with two lines, one for Plc and another for Prc
    g <- ggplot(file.final.sensor, aes(x = Time..s.)) +
            geom_line(aes(y = Plc..hPa., color = "Plc")) +   # First line for Plc
            geom_line(aes(y = Prc..hPa., color = "Prc")) +   # Second line for Prc
            geom_hline(yintercept = threshold, linetype = "dashed", color = "black") +  # Threshold line
            theme_minimal() +
            ggtitle(paste0(s, "/", i)) +
            scale_color_manual(name = "Legend", values = c("Plc" = "blue", "Prc" = "red"))  # Custom colors for each line
    
    l[[k]] <- ggplotly(g)
    
    # Calculate the time for which Prc exceeds the threshold
    prc_over_threshold <- file.final.sensor$Prc..hPa. > threshold
    time_above_threshold <- sum(diff(file.final.sensor$Time..s.)[prc_over_threshold[-1]])  # Summing the time differences where Prc is above threshold
    
    # Calculate average and maximum Prc values for the periods where Prc exceeds the threshold
    avg_prc_above_threshold <- mean(file.final.sensor$Prc..hPa.[prc_over_threshold], na.rm = TRUE)
    max_prc_above_threshold <- max(file.final.sensor$Prc..hPa.[prc_over_threshold], na.rm = TRUE)
    
    # Print the results
    print(paste0("Sensor: ", i, " for Scenario: ", s, 
                 " exceeds threshold for ", time_above_threshold, " seconds. ",
                 "Average Prc: ", round(avg_prc_above_threshold, 2), " hPa, ",
                 "Max Prc: ", round(max_prc_above_threshold, 2), " hPa."))
    
    rm(file.final.sensor)
  }
  
  rm(file.final.scenario)
}


```
